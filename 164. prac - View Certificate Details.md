### 164. prac - View Certificate Details
- apiserver의 인증서 파일 확인
```bash
controlplane ~ ➜  ls /etc/kubernetes/pki/
apiserver.crt                 etcd
apiserver-etcd-client.crt     front-proxy-ca.crt
apiserver-etcd-client.key     front-proxy-ca.key
apiserver.key                 front-proxy-client.crt
apiserver-kubelet-client.crt  front-proxy-client.key
apiserver-kubelet-client.key  sa.key
ca.crt                        sa.pub
ca.key

controlplane ~ ✖ cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep -E "*.crt"
    - --tls-cert-file=/etc/kubernetes/pki/apiserver.crt
```

- apiserver에서 etcd 인증을 위해서 사용하는 인증서 파일 식별
  & apiserver에서 client인 kubelet 인증을 위해서 사용하는 키 식별
```bash
controlplane ~ ➜  cat /etc/kubernetes/manifests/kube-apiserver.yaml
---
...
    - --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt
...
    - --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key
...
```

- etcd의 인증서 확인
```bash
controlplane ~ ➜  cat /etc/kubernetes/manifests/etcd.yaml
---
...
    - --cert-file=/etc/kubernetes/pki/etcd/server.crt
...
---
```

- etcd 서버를 위한 etcd 서버 CA 루트 인증서를 식별
```bash
controlplane ~ ➜  cat /etc/kubernetes/manifests/etcd.yaml | grep -E "*.crt"
---
...
    - --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt
```

- apiserver 인증을 위해 사용되는 CN(Common Name) & CA(인증 기관) 확인
```bash
controlplane ~ ➜  openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout | grep CN
---
        Issuer: CN = kubernetes    # CA
        Subject: CN = kube-apiserver    # CN
---
```

- apiserver 인증 과정에서 사용되는 alternate names 확인
```bash
controlplane ~ ➜  openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout 
---
...
X509v3 Subject Alternative Name: 
                DNS:controlplane, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, IP Address:172.20.0.1, IP Address:192.168.60.169
...
---
```

- etcd 서버의 CN (Common Name) 확인
```bash
controlplane ~ ✖ openssl x509 -in /etc/kubernetes/pki/etcd/server.crt -text -noout | grep -i subject
---
        Subject: CN = controlplane
        Subject Public Key Info:
            X509v3 Subject Alternative Name: 
---
```

- apiserver 인증서의 유효기간 확인
	- 기본 값은 클러스터 생성 시점으로부터 1년이다.
```bash
controlplane ~ ➜  openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout 
---
...
        Validity
            Not Before: Aug  6 22:20:33 2025 GMT
            Not After : Aug  6 22:25:33 2026 GMT
...
---
```

- CA의 인정서인 Root 인증서(`ca.crt`)의 유효기간 확인
```bash
controlplane ~ ➜  openssl x509 -in /etc/kubernetes/pki/ca.crt -text -noout | grep -A2 -i valid
---
        Validity
            Not Before: Aug  6 22:20:33 2025 GMT
            Not After : Aug  4 22:25:33 2035 GMT
---
```

- kubectl이 갑자기 명령에 응답않는 상황. `/etc/kubernetes/manifests/etcd.yaml` 파일을 을 최근에 누군가가 수정. 올바르게 변경하여 복구
```bash
controlplane ~ ➜  kubectl logs etcd -n kube-system
The connection to the server controlplane:6443 was refused - did you specify the right host or port?



controlplane ~ ➜  /etc/kubernetes/pki/etcd/
ca.crt  healthcheck-client.crt  peer.crt  server.crt
ca.key  healthcheck-client.key  peer.key  server.key

controlplane ~ ➜  vi /etc/kubernetes/manifests/etcd.yaml 
---
...
    - --cert-file=/etc/kubernetes/pki/etcd/server-certificate.crt
    # 다음과 같이 올바르게 수정
    - --cert-file=/etc/kubernetes/pki/etcd/server.crt
...
---
```

- kube-apiserver가 다시 한번 정지. kube-apiserver의 로그를 확인하고 근본 원인을 식별. 수정해서 복구.
	- 참고 : 컨테이너 수준의 log를 확인
		- `crictl ps -a`
		- `crictl logs <CONTIANER_ID>`
	- kuberentes에는 자체 CA 파일이 있다. => `/etc/kubernetes/pki/ca.crt`
	- etcd 인증에는 etcd 자체 CA 파일을 사용해야 한다. => `/etcd/kubernetes/pki/etcd/ca.crt`
```bash
controlplane ~ ➜  crictl ps -a | grep kube-apiserver
8950d849dbaf0       6ba9545b2183e       56 seconds ago      Exited              kube-apiserver            4                   e03f9d8552327       kube-apiserver-controlplane            kube-system


controlplane ~ ➜  crictl logs 237104c19c82b
...
W0806 23:35:34.498284       1 logging.go:55] [core] [Channel #2 SubChannel #4]grpc: addrConn.createTransport failed to connect to {Addr: "127.0.0.1:2379", ServerName: "127.0.0.1:2379", }. Err: connection error: desc = "transport: authentication handshake failed: tls: failed to verify certificate: x509: certificate signed by unknown authority"
...


controlplane ~ ➜  ls /etc/kubernetes/pki/
apiserver.crt                 apiserver-kubelet-client.key  front-proxy-ca.key
apiserver-etcd-client.crt     ca.crt                        front-proxy-client.crt
apiserver-etcd-client.key     ca.key                        front-proxy-client.key
apiserver.key                 etcd                          sa.key
apiserver-kubelet-client.crt  front-proxy-ca.crt            sa.pub

controlplane ~ ➜  ls /etc/kubernetes/pki/etcd/
ca.crt  healthcheck-client.crt  peer.crt  server.crt
ca.key  healthcheck-client.key  peer.key  server.key

controlplane ~ ➜  openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout | grep Issuer
        Issuer: CN = kubernetes

controlplane ~ ➜  vi /etc/kuberentes/manifest/kube-apiserver.yaml | grep -E "\-\-etcd"
---
...
    - --etcd-cafile=/etc/kubernetes/pki/ca.crt
    # 다음과 같이 수정 : etcd의 ca 인증서를 사용
    - --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt
```