### 312. Network Troubleshooting
#### Network Troubleshooting#1
- 다음과 같은 아키텍처에서 애플리케이션 접속이 안되는 상황. 이를 트러블 슈팅
```text
namespaec: triton

web-service
     │
     ▼
webapp-mysql ────▶ mysql (Service)
                       │
                       ▼
                    mysql (Pod)
```

- 네임스페이스 내 서비스, 디플로이먼트, 파드 상태 확인
```bash
root@controlplane ~ ➜  k get svc,deploy,po -n triton
NAME                  TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
service/mysql         ClusterIP   10.96.204.189    <none>        3306/TCP         17m
service/web-service   NodePort    10.106.120.178   <none>        8080:30081/TCP   17m

NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/webapp-mysql   0/1     1            0           17m

NAME                                READY   STATUS              RESTARTS   AGE
pod/mysql                           0/1     ContainerCreating   0          17m
pod/webapp-mysql-7bd5857746-tnbqq   0/1     ContainerCreating   0          17m
```

- `web-service` IP 주소로 통신 테스트
```bash
root@controlplane ~ ➜  curl http://10.106.120.178:8080
curl: (7) Failed to connect to 10.106.120.178 port 8080 after 0 ms: Connection refused
```

- `web-service` 세부사항 확인
```bash
root@controlplane ~ ✖ k describe -n triton svc web-service
```

- 파드 상태 확인 및 세부사항 확인
	- weave CNI와 관련해서 네트워크를 구성하는 것이 실패했다는 로그 확인
```bash
root@controlplane ~ ➜  k get po -n triton
NAME                            READY   STATUS              RESTARTS   AGE
mysql                           0/1     ContainerCreating   0          26m
webapp-mysql-7bd5857746-tnbqq   0/1     ContainerCreating   0          26m

root@controlplane ~ ➜  k describe -n triton po webapp-mysql-7bd5857746-tnbqq 
...
Events:
  ...
    Failed to create pod sandbox: rpc error: code = Unknown desc = failed to setup network for sandbox "654d8fa8bb79c5ba7d7df1f6622466cc238cc32c5dba7b94b9d731a88b008434": plugin type="weave-net" name="weave" failed
```

- 정확한 원인을 파악을 위해, `weave-net` 파드의 로그를 확인하려 했으나, `weave` 파드가 없는 상태.
	- 즉, weave CNI가 제대로 배포되지 않았음을 확인인
```bash
root@controlplane ~ ➜  k get po -A
NAMESPACE     NAME                                   READY   STATUS              RESTARTS   AGE
kube-system   coredns-674b8bbfcf-qrfsw               1/1     Running             0          55m
kube-system   coredns-674b8bbfcf-rf7xk               1/1     Running             0          55m
kube-system   etcd-controlplane                      1/1     Running             0          55m
kube-system   kube-apiserver-controlplane            1/1     Running             0          55m
kube-system   kube-controller-manager-controlplane   1/1     Running             0          55m
kube-system   kube-proxy-tpfq7                       1/1     Running             0          55m
kube-system   kube-scheduler-controlplane            1/1     Running             0          55m
triton        mysql                                  0/1     ContainerCreating   0          29m
triton        webapp-mysql-7bd5857746-tnbqq          0/1     ContainerCreating   0          29m
```

- weave CNI 재배포
```bash
root@controlplane ~ ➜  curl -L https://github.com/weaveworks/weave/releases/download/latest_release/weave-daemonset-k8s-1.11.yaml | kubectl apply -f -
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
100  6183  100  6183    0     0  18682      0 --:--:-- --:--:-- --:--:-- 18682
serviceaccount/weave-net created
clusterrole.rbac.authorization.k8s.io/weave-net created
clusterrolebinding.rbac.authorization.k8s.io/weave-net created
role.rbac.authorization.k8s.io/weave-net created
rolebinding.rbac.authorization.k8s.io/weave-net created
daemonset.apps/weave-net created
```

 - weave 파드 확인
```bash
root@controlplane ~ ➜  k get po -A
...
kube-system   weave-net-q985m                        2/2     Running   0          26s
...
```

- 파드 확인
```bash
root@controlplane ~ ➜  k get po -n triton 
NAME                            READY   STATUS    RESTARTS   AGE
mysql                           1/1     Running   0          30m
webapp-mysql-7bd5857746-tnbqq   1/1     Running   0          30m
```


#### Network Troubleshooting#2
- 웹 애플리케이션에 접속이 안되는 상황. 이를 트러블 슈팅

- `web-service`의 IP로 통신 테스트
```bash
root@controlplane ~ ➜  curl http://10.98.248.162:8080
```

- `triton` 네임스페이스 내 모든 리소스 상태 확인
```bash
root@controlplane ~ ➜  k get all -n triton
NAME                                READY   STATUS    RESTARTS   AGE
pod/mysql                           1/1     Running   0          40s
pod/webapp-mysql-7bd5857746-vsqww   1/1     Running   0          40s

NAME                  TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
service/mysql         ClusterIP   10.106.171.219   <none>        3306/TCP         40s
service/web-service   NodePort    10.98.248.162    <none>        8080:30081/TCP   40s

NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/webapp-mysql   1/1     1            1           40s

NAME                                      DESIRED   CURRENT   READY   AGE
replicaset.apps/webapp-mysql-7bd5857746   1         1         1       40s
```

- 노드 상태 확인
```bash
root@controlplane ~ ➜  k get no
NAME           STATUS   ROLES           AGE   VERSION
controlplane   Ready    control-plane   59m   v1.33.0
```

- 전체 파드 확인
	- `kube-proxy` 파드가 비정상임을 확인인
```bash
root@controlplane ~ ➜  k get po -A
NAMESPACE     NAME                                   READY   STATUS             RESTARTS      AGE
kube-system   coredns-674b8bbfcf-qrfsw               1/1     Running            0             59m
kube-system   coredns-674b8bbfcf-rf7xk               1/1     Running            0             59m
kube-system   etcd-controlplane                      1/1     Running            0             59m
kube-system   kube-apiserver-controlplane            1/1     Running            0             59m
kube-system   kube-controller-manager-controlplane   1/1     Running            0             59m
kube-system   kube-proxy-6z9mb                       0/1     CrashLoopBackOff   4 (31s ago)   2m11s
kube-system   kube-scheduler-controlplane            1/1     Running            0             59m
kube-system   weave-net-q985m                        2/2     Running            0             3m18s
triton        mysql                                  1/1     Running            0             2m10s
triton        webapp-mysql-7bd5857746-vsqww          1/1     Running            0             2m10s
```

- `kube-proxy` 파드의 로그 확인
	- 컨테이너를 실행하는 중 `/var/lib/kube-proxy/configuration.conf` 파일을 찾을수 없어서 실패함을 확인
```bash
root@controlplane ~ ➜  k logs -n kube-system kube-proxy-sn8bs
E0819 07:05:40.935590       1 run.go:74] "command failed" err="failed complete: open /var/lib/kube-proxy/configuration.conf: no such file or directory"
```

- `kube-proxy` 파드 세부사항 확인
```bash
root@controlplane ~ ➜  k describe -n kube-system po kube-proxy-sn8bs
```

- `kube-proxy` 파드 세부사항 확인
	- `--config=/var/lib/kube-proxy/configuration.conf`로 설정됨을 확인
```bash
root@controlplane ~ ➜  k get -n kube-system po kube-proxy-sn8bs -o yaml
...
  containers:
  - command:
    - /usr/local/bin/kube-proxy
    - --config=/var/lib/kube-proxy/configuration.conf
    - --hostname-override=$(NODE_NAME)
...
```

- `kube-proxy` 파드는 데몬셋에 의해 배포되니, `kube-proxy` 데몬셋 세부사항 확인
```bash
root@controlplane ~ ➜  k get -n kube-system ds kube-proxy -o yaml
...
      containers:
      - command:
        - /usr/local/bin/kube-proxy
        - --config=/var/lib/kube-proxy/configuration.conf
        - --hostname-override=$(NODE_NAME)
...
```

- `kube-proxy` 데몬셋 내 설정을 올바르게 수정
```bash
root@controlplane ~ ➜  k edit -n kube-system ds kube-proxy
---
...
    spec:
      containers:
      - command:
        - /usr/local/bin/kube-proxy
        - --config=/var/lib/kube-proxy/config.conf
        - --hostname-override=$(NODE_NAME)
...
---
daemonset.apps/kube-proxy edited
```

 - 파드 상태 확인인
```bash
root@controlplane ~ ➜  k get po,ds -A
NAMESPACE     NAME                                       READY   STATUS    RESTARTS      AGE
kube-system   pod/coredns-674b8bbfcf-2qjsb               1/1     Running   0             35m
kube-system   pod/coredns-674b8bbfcf-gjdbm               1/1     Running   0             35m
kube-system   pod/etcd-controlplane                      1/1     Running   0             35m
kube-system   pod/kube-apiserver-controlplane            1/1     Running   0             35m
kube-system   pod/kube-controller-manager-controlplane   1/1     Running   0             35m
kube-system   pod/kube-proxy-htp99                       1/1     Running   0             31s
kube-system   pod/kube-scheduler-controlplane            1/1     Running   0             35m
kube-system   pod/weave-net-w6xsf                        2/2     Running   0             7m27s
triton        pod/mysql                                  1/1     Running   1 (40s ago)   7m2s
triton        pod/webapp-mysql-7bd5857746-5mkxv          1/1     Running   0             7m1s

NAMESPACE     NAME                        DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
kube-system   daemonset.apps/kube-proxy   1         1         1       1            1           kubernetes.io/os=linux   7m2s
kube-system   daemonset.apps/weave-net    1         1         1       1            1           <none>                   7m27s
```