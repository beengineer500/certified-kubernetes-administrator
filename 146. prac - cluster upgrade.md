---
index: "[[ğŸ· Lecture Notes]]"
tags:
  - Kubernetes
  - Kubernetes/k8s
  - Kubernetes/Cluster
  - Kubernetes/ClusterUpgrade
created: 2025-05-26 09:20
status: 
source_url:
---
>[!info] Link
>- 

---

### 146. prac - cluster upgrade
- ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° ë²„ì „ ë° ë…¸ë“œ, ë””í”Œë¡œì´ë¨¼íŠ¸, íŒŒë“œ í™•ì¸
```bash
controlplane ~ âœ  kubeadm version
kubeadm version: &version.Info{Major:"1", Minor:"32", GitVersion:"v1.32.0", GitCommit:"70d3cc986aa8221cd1dfb1121852688902d3bf53", GitTreeState:"clean", BuildDate:"2024-12-11T18:04:20Z", GoVersion:"go1.23.3", Compiler:"gc", Platform:"linux/amd64"}

controlplane ~ âœ– kubectl version
Client Version: v1.32.0
Kustomize Version: v5.5.0
Server Version: v1.32.0

controlplane ~ âœ  kubelet --version
Kubernetes v1.32.0

controlplane ~ âœ  k get no
NAME           STATUS   ROLES           AGE   VERSION
controlplane   Ready    control-plane   21m   v1.32.0
node01         Ready    <none>          20m   v1.32.0


controlplane ~ âœ  k get deploy
NAME   READY   UP-TO-DATE   AVAILABLE   AGE
blue   5/5     5            5           4m43s



controlplane ~ âœ  k get po -o wide
NAME                    READY   STATUS    RESTARTS   AGE     IP           NODE           NOMINATED NODE   READINESS GATES
blue-69968556cc-9qz2t   1/1     Running   0          5m14s   172.17.1.4   node01         <none>           <none>
blue-69968556cc-gcnjf   1/1     Running   0          5m14s   172.17.0.5   controlplane   <none>           <none>
blue-69968556cc-lns2q   1/1     Running   0          5m14s   172.17.1.2   node01         <none>           <none>
blue-69968556cc-nkb4d   1/1     Running   0          5m14s   172.17.1.3   node01         <none>           <none>
blue-69968556cc-rm9wk   1/1     Running   0          5m14s   172.17.0.4   controlplane   <none>           <none>
```

- `controlplane` ì¿ ë²„ë„¤í‹°ìŠ¤ ë²„ì „ ì—…ê·¸ë ˆì´ë“œë¥¼ ìœ„í•´, `kubectl drain` ìˆ˜í–‰
```bash
controlplane ~ âœ  kubectl describe no controlplane | grep -i taint
Taints:             <none>



controlplane ~ âœ  kubectl drain controlplane --ignore-daemonsets 
node/controlplane cordoned
Warning: ignoring DaemonSet-managed Pods: kube-flannel/kube-flannel-ds-kvnw9, kube-system/kube-proxy-bwfkd
evicting pod kube-system/coredns-7484cd47db-gpfj7
evicting pod default/blue-69968556cc-rm9wk
evicting pod default/blue-69968556cc-gcnjf
evicting pod kube-system/coredns-7484cd47db-99vh7
pod/blue-69968556cc-rm9wk evicted
pod/blue-69968556cc-gcnjf evicted
pod/coredns-7484cd47db-gpfj7 evicted
pod/coredns-7484cd47db-99vh7 evicted
node/controlplane drained



controlplane ~ âœ  kubectl describe no controlplane | grep -i taint
Taints:             node.kubernetes.io/unschedulable:NoSchedule


controlplane ~ âœ  kubectl get po -o wide
NAME                    READY   STATUS    RESTARTS   AGE    IP           NODE     NOMINATED NODE   READINESS GATES
blue-69968556cc-2m4fx   1/1     Running   0          115s   172.17.1.9   node01   <none>           <none>
blue-69968556cc-9qz2t   1/1     Running   0          13m    172.17.1.4   node01   <none>           <none>
blue-69968556cc-bzgp4   1/1     Running   0          115s   172.17.1.8   node01   <none>           <none>
blue-69968556cc-lns2q   1/1     Running   0          13m    172.17.1.2   node01   <none>           <none>
blue-69968556cc-nkb4d   1/1     Running   0          13m    172.17.1.3   node01   <none>           <none>



controlplane ~ âœ  kubectl get po -o wide -n kube-system
NAME                                   READY   STATUS    RESTARTS   AGE    IP               NODE           NOMINATED NODE   READINESS GATES
coredns-7484cd47db-hqq9m               1/1     Running   0          2m7s   172.17.1.10      node01         <none>           <none>
coredns-7484cd47db-swnhp               1/1     Running   0          2m7s   172.17.1.11      node01         <none>           <none>
etcd-controlplane                      1/1     Running   0          31m    192.168.104.46   controlplane   <none>           <none>
kube-apiserver-controlplane            1/1     Running   0          31m    192.168.104.46   controlplane   <none>           <none>
kube-controller-manager-controlplane   1/1     Running   0          31m    192.168.104.46   controlplane   <none>           <none>
kube-proxy-bwfkd                       1/1     Running   0          31m    192.168.104.46   controlplane   <none>           <none>
kube-proxy-k2ssr                       1/1     Running   0          31m    192.168.130.17   node01         <none>           <none>
kube-scheduler-controlplane            1/1     Running   0          31m    192.168.104.46   controlplane   <none>           <none>
```

- `kubeadm` ì—…ê·¸ë ˆì´ë“œ(1.32.0 -> 1.33.0)
```bash
# kubernetes repo ì •ë³´ ì—…ë°ì´íŠ¸ : v1.32 -> v1.33
controlplane ~ âœ  vi /etc/apt/sources.list.d/kubernetes.list 
---
deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /
---

controlplane ~ âœ  apt update

# kubeadm ì„¤ì¹˜ ê°€ëŠ¥ íŒ¨í‚¤ì§€ í™•ì¸
controlplane ~ âœ  apt-cache madison kubeadm
   kubeadm | 1.33.2-1.1 | https://pkgs.k8s.io/core:/stable:/v1.33/deb  Packages
   kubeadm | 1.33.1-1.1 | https://pkgs.k8s.io/core:/stable:/v1.33/deb  Packages
   kubeadm | 1.33.0-1.1 | https://pkgs.k8s.io/core:/stable:/v1.33/deb  Packages

# kubeadm v1.33 ì„¤ì¹˜
controlplane ~ âœ  apt-get install kubeadm=1.33.0-1.1


# kubeadm ë²„ì „ ì—…ê·¸ë ˆì´ë“œ (5ë¶„ ì •ë„ ì†Œìš”)
controlplane ~ âœ  kubeadm upgrade plan v1.33.0
controlplane ~ âœ  kubeadm upgrade apply v1.33.0


# í™•ì¸
controlplane ~ âœ  kubeadm version
kubeadm version: &version.Info{Major:"1", Minor:"33", EmulationMajor:"", EmulationMinor:"", MinCompatibilityMajor:"", MinCompatibilityMinor:"", GitVersion:"v1.33.0", GitCommit:"60a317eadfcb839692a68eab88b2096f4d708f4f", GitTreeState:"clean", BuildDate:"2025-04-23T13:05:48Z", GoVersion:"go1.24.2", Compiler:"gc", Platform:"linux/amd64"}
```

- `kubelet` ì—…ê·¸ë ˆì´ë“œ(1.32.0 -> 1.33.0)
```bash
# í˜„ì¬ ë²„ì „ í™•ì¸
controlplane ~ âœ  kubelet --version
Kubernetes v1.32.0


# kubelet ì„¤ì¹˜ ê°€ëŠ¥ ë²„ì „ í™•ì¸
controlplane ~ âœ  apt-cache madison kubelet
   kubelet | 1.33.2-1.1 | https://pkgs.k8s.io/core:/stable:/v1.33/deb  Packages
   kubelet | 1.33.1-1.1 | https://pkgs.k8s.io/core:/stable:/v1.33/deb  Packages
   kubelet | 1.33.0-1.1 | https://pkgs.k8s.io/core:/stable:/v1.33/deb  Packages


# kubelet v1.33.0 ì„¤ì¹˜
controlplane ~ âœ  apt-get install kubelet=1.33.0-1.1

# ì‹œìŠ¤í…œ ë°ëª¬ reload ë° kubelet ì¬ì‹œì‘
controlplane ~ âœ  systemctl daemon-reload
controlplane ~ âœ  systemctl restart kubelet

# í™•ì¸
controlplane ~ âœ  kubelet --version
Kubernetes v1.33.0
```

- `kubectl uncordon controlplan`ìœ¼ë¡œ ìŠ¤ì¼€ì¥´ë§ ë³µêµ¬
```bash
controlplane ~ âœ  kubectl uncordon controlplane 
node/controlplane uncordoned
```

- `node01` ë“œë ˆì¸
```bash
# í˜„ì¬ ìƒíƒœ í™•ì¸
controlplane ~ âœ  kubectl get po -o wide
NAME                    READY   STATUS    RESTARTS   AGE   IP           NODE     NOMINATED NODE   READINESS GATES
blue-69968556cc-2m4fx   1/1     Running   0          25m   172.17.1.9   node01   <none>           <none>
blue-69968556cc-9qz2t   1/1     Running   0          36m   172.17.1.4   node01   <none>           <none>
blue-69968556cc-bzgp4   1/1     Running   0          25m   172.17.1.8   node01   <none>           <none>
blue-69968556cc-lns2q   1/1     Running   0          36m   172.17.1.2   node01   <none>           <none>
blue-69968556cc-nkb4d   1/1     Running   0          36m   172.17.1.3   node01   <none>           <none>

# worker01 drain
controlplane ~ âœ  kubectl drain node01 --ignore-daemonsets
node/node01 cordoned
Warning: ignoring DaemonSet-managed Pods: kube-flannel/kube-flannel-ds-42nm2, kube-system/kube-proxy-hssvl
evicting pod kube-system/coredns-674b8bbfcf-xp2wx
evicting pod default/blue-69968556cc-bzgp4
evicting pod default/blue-69968556cc-nkb4d
evicting pod default/blue-69968556cc-9qz2t
evicting pod kube-system/coredns-674b8bbfcf-h2b5w
evicting pod default/blue-69968556cc-2m4fx
evicting pod default/blue-69968556cc-lns2q
pod/blue-69968556cc-lns2q evicted
pod/blue-69968556cc-nkb4d evicted
pod/blue-69968556cc-9qz2t evicted
pod/blue-69968556cc-2m4fx evicted
pod/blue-69968556cc-bzgp4 evicted
pod/coredns-674b8bbfcf-h2b5w evicted
pod/coredns-674b8bbfcf-xp2wx evicted
node/node01 drained

# íŒŒë“œ í™•ì¸
controlplane ~ âœ  kubectl get po -o wide
NAME                    READY   STATUS    RESTARTS   AGE   IP            NODE           NOMINATED NODE   READINESS GATES
blue-69968556cc-27wnk   1/1     Running   0          32s   172.17.0.6    controlplane   <none>           <none>
blue-69968556cc-2nknb   1/1     Running   0          32s   172.17.0.9    controlplane   <none>           <none>
blue-69968556cc-5wsrz   1/1     Running   0          32s   172.17.0.7    controlplane   <none>           <none>
blue-69968556cc-dqpbc   1/1     Running   0          32s   172.17.0.10   controlplane   <none>           <none>
blue-69968556cc-sgljs   1/1     Running   0          32s   172.17.0.12   controlplane   <none>           <none>
```

- `node01` ë…¸ë“œ `kubeadm` ì—…ê·¸ë ˆì´ë“œ
```bash
# node ì •ë³´ í™•ì¸
controlplane ~ âœ  kubectl get no -o wide
NAME           STATUS                     ROLES           AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION    CONTAINER-RUNTIME
controlplane   Ready                      control-plane   56m   v1.33.0   192.168.104.46   <none>        Ubuntu 22.04.5 LTS   5.15.0-1083-gcp   containerd://1.6.26
node01         Ready,SchedulingDisabled   <none>          56m   v1.32.0   192.168.130.17   <none>        Ubuntu 22.04.4 LTS   5.15.0-1083-gcp   containerd://1.6.26


# SSH ì ‘ì†
ssh node01


# kubernets repo ì •ë³´ ì—…ë°ì´íŠ¸
node01 ~ âœ  vi /etc/apt/sources.list.d/kubernetes.list 
 ~ âœ  vi /etc/apt/sources.list.d/kubernetes.list 
 ~ âœ  vi /etc/apt/sources.list.d/kubernetes.list 
---
deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /
---

node01 ~ âœ  apt update

node01 ~ âœ  apt-cache madison kubeadm

node01 ~ âœ  apt-get install kubeadm=1.33.0-1.1

node01 ~ âœ  kubeadm upgrade node

node01 ~ âœ  kubeadm version
kubeadm version: &version.Info{Major:"1", Minor:"33", EmulationMajor:"", EmulationMinor:"", MinCompatibilityMajor:"", MinCompatibilityMinor:"", GitVersion:"v1.33.0", GitCommit:"60a317eadfcb839692a68eab88b2096f4d708f4f", GitTreeState:"clean", BuildDate:"2025-04-23T13:05:48Z", GoVersion:"go1.24.2", Compiler:"gc", Platform:"linux/amd64"}
```

- `node01` ë…¸ë“œ `kubelet` ì—…ê·¸ë ˆì´ë“œ
```bash
node01 ~ âœ  apt-cache madison kubelet

node01 ~ âœ– apt-get install kubelet=1.33.0-1.1

node01 ~ âœ  systemctl daemon-reload

node01 ~ âœ  systemctl restart kubelet

node01 ~ âœ  kubelet --version
Kubernetes v1.33.0
```


- `controlplan`ì—ì„œ ë…¸ë“œ ì •ë³´ í™•ì¸
	- ==`node01`ì—ì„œ `kubelet`ì„ ì¬ì‹œì‘í•˜ì§€ í•˜ì§€ ì•Šìœ¼ë©´, ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ ì›Œì»¤ë…¸ë“œì˜ ì—…ê·¸ë ˆì´ë“œëœ ë²„ì „ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ë‹¤.==
		- kubelet ë²„ì „ì„ ë”°ë¼ê°€ëŠ” ê±´ì§€, ì•„ë‹ˆë©´ kubeletì„ ì¬ì‹œì‘í•´ì•¼ ë…¸ë“œì˜ ì¿ ë²„ë„¤í‹°ìŠ¤ ì •ë³´ë¥¼ ì½ì–´ì˜¤ëŠ” ê±´ì§€ í™•ì¸ í•„ìš”
```bash
controlplane ~ âœ  kubectl get no -o wide
NAME           STATUS                     ROLES           AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION    CONTAINER-RUNTIME
controlplane   Ready                      control-plane   71m   v1.33.0   192.168.104.46   <none>        Ubuntu 22.04.5 LTS   5.15.0-1083-gcp   containerd://1.6.26
node01         Ready,SchedulingDisabled   <none>          71m   v1.33.0   192.168.130.17   <none>        Ubuntu 22.04.4 LTS   5.15.0-1083-gcp   containerd://1.6.26
```

- `node01` `uncordon`ìœ¼ë¡œ ìŠ¤ì¼€ì¥´ë§ ë³µêµ¬
```bash
controlplane ~ âœ  kubectl uncordon node01
node/node01 uncordoned
```






---

# References
- 