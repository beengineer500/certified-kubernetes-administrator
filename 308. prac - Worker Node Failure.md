### 308. prac - Worker Node Failure
- Step1. Check the status of services on the nodes.  
- Step2. Check the service logs using `journalctl -u kubelet` 
- Step3. If it's stopped then start the stopped services.

#### Worker Node Failure#1
- 워커 노드가 비정상인 상태. 이를 트러블 슈팅
```bash
controlplane ~ ➜  k get no -o wide
NAME           STATUS     ROLES           AGE   VERSION   INTERNAL-IP       EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION    CONTAINER-RUNTIME
controlplane   Ready      control-plane   11m   v1.33.0   192.168.60.183    <none>        Ubuntu 22.04.5 LTS   5.15.0-1083-gcp   containerd://1.6.26
node01         NotReady   <none>          11m   v1.33.0   192.168.231.189   <none>        Ubuntu 22.04.5 LTS   5.15.0-1083-gcp   containerd://1.6.26
```

- 워커 노드로 SSH 접속
```bash
controlplane ~ ➜  ssh node01
```

- `kubelet` 상태 확인
	- 실행이 안된 상태임을 확인
```bash
node01 ~ ➜  systemctl status kubelet
...
     Active: inactive (dead) since Tue 2025-08-19 01:09:37 UTC; 7min ago
...
```

- `kubelet` 실행
```bash
node01 ~ ➜  systemctl start kubelet

node01 ~ ➜  systemctl status kubelet
...
     Active: active (running) since Tue 2025-08-19 01:17:01 UTC; 2s ago
...
```

- 노드 상태 확인인
```bash
controlplane ~ ➜  k get no
NAME           STATUS   ROLES           AGE   VERSION
controlplane   Ready    control-plane   19m   v1.33.0
node01         Ready    <none>          18m   v1.33.0
```


#### Worker Node Failure#2
- 워커 노드가 비정상인 상태. 이를 트러블 슈팅
```bash
controlplane ~ ➜  k get no -o wide
NAME           STATUS     ROLES           AGE   VERSION   INTERNAL-IP       EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION    CONTAINER-RUNTIME
controlplane   Ready      control-plane   20m   v1.33.0   192.168.60.183    <none>        Ubuntu 22.04.5 LTS   5.15.0-1083-gcp   containerd://1.6.26
node01         NotReady   <none>          19m   v1.33.0   192.168.231.189   <none>        Ubuntu 22.04.5 LTS   5.15.0-1083-gcp   containerd://1.6.26
```

- `kubelet`이 계속 재시작 중임을 확인
```bash
node01 ~ ✖ systemctl status kubelet
● kubelet.service - kubelet: The Kubernetes Node Agent
     Loaded: loaded (/lib/systemd/system/kubelet.service; enabled; vendor preset: enabled)
    Drop-In: /usr/lib/systemd/system/kubelet.service.d
             └─10-kubeadm.conf
     Active: activating (auto-restart) (Result: exit-code) since Tue 2025-08-19 01:21:18 UTC; 2s ago
```

- `kubelet`의 로그 확인
	- CA 파일을 불러올 수 없다는 로그 확인
```bash
node01 ~ ➜  journalctl -u kubelet
...
unable to load client CA file /etc/kubernetes/pki/WRONG-CA-FILE.crt
...
```

- CA 인증서의 경로와 파일명을 확인
```bash
node01 ~ ➜  ls /etc/kubernetes/pki/
ca.crt
```

- 컨트롤 플레인에서 `kubelet` config 파일 위치 확인
```bash
controlplane ~ ✖ systemctl status kubelet
...
  --config=/var/lib/kubelet/config.yaml
...
```

- 컨트롤 플레인의 `kubelet` 컨피그 파일 경로를 참고하여, 워커 노드에서 `kubelet` 컨피그 파일 확인
	- `clientCAFile` 파일명이 잘못 설정됨을 확인
```bash
node01 ~ ➜  cat /var/lib/kubelet/config.yaml
...
  x509:
    clientCAFile: /etc/kubernetes/pki/WRONG-CA-FILE.crt
...
```

 - `clientCAFile` 파일명을 올바르게 수정정
```bash
node01 ~ ➜  vi /var/lib/kubelet/config.yaml
---
...
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.crt
...
```

- 올바른 인증서를 불러오도록 `kubelet`을 재시작 및 상태 확인
```bash
node01 ~ ➜  systemctl restart kubelet

node01 ~ ➜  systemctl status kubelet
...
     Active: active (running) since Tue 2025-08-19 01:32:32 UTC; 9s ago
...
```

- 노드 상태 확인
```bash
controlplane ~ ➜  k get no
NAME           STATUS   ROLES           AGE   VERSION
controlplane   Ready    control-plane   19m   v1.33.0
node01         Ready    <none>          18m   v1.33.0
```


#### Worker Node Failure#3
- 워커 노드가 비정상인 상태. 이를 트러블 슈팅
```bash
controlplane ~ ➜  k get no -o wide
NAME           STATUS     ROLES           AGE   VERSION   INTERNAL-IP       EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION    CONTAINER-RUNTIME
controlplane   Ready      control-plane   34m   v1.33.0   192.168.60.183    <none>        Ubuntu 22.04.5 LTS   5.15.0-1083-gcp   containerd://1.6.26
node01         NotReady   <none>          33m   v1.33.0   192.168.231.189   <none>        Ubuntu 22.04.5 LTS   5.15.0-1083-gcp   containerd://1.6.26
```

- 워커 노드로 SSH 접속
```bash
controlplane ~ ➜  ssh node01
```

- `kubelet` 상태 확인
```bash
node01 ~ ➜  systemctl status kubelet
...
     Active: active (running) since Tue 2025-08-19 01:33:07 UTC; 2min 4s ago
...
```

- `journalctl`을 통해서 `kubelet` 로그 확인
	- `kube-apiserver`의 포트는 6443인데, 6553으로 통신하고 있음을 확인
```bash
node01 ~ ✖ journalctl -u kubelet 
...
   "Attempting to register node" node="node01" ...
   "Unable to register node with API server" err="Post \"https://controlplane:6553/api/v1/nodes\": dial tcp 192.168.60.183:6553: connect: connection refused" node="node01"
...
```

- `kubelet` 컨피그 파일 확인
```bash
node01 ~ ➜  cat /etc/kubernetes/kubelet.conf 
...
    server: https://controlplane:6553
...
```

- 컨트롤 플레인의 API 서버와 올바른 포트를 통해서 통신하도록 `kubelet` 컨피그 파일을 수정
```bash
node01 ~ ➜  vi /etc/kubernetes/kubelet.conf 
...
    server: https://controlplane:6443
...
```

- `kubelet` 재시작
```bash
node01 ~ ➜  systemctl restart kubelet
```

- `kubelet` 확인
```bash
node01 ~ ➜  systemctl status kubelet
...
     Active: active (running) since Tue 2025-08-19 01:43:49 UTC; 32s ago
...
```

- `kubelet` 로그 특이상 여부 확인
```bash
node01 ~ ➜  journalctl -u kubelet
```

- 노드 확인
```bash
controlplane ~ ➜  k get no
NAME           STATUS   ROLES           AGE   VERSION
controlplane   Ready    control-plane   44m   v1.33.0
node01         Ready    <none>          43m   v1.33.0
```