### 302. prac - Application Failure
#### Application Failure TroubleShooting#1
```text
User -(port:30081)-> web-service -(port:8080)-> webapp-mysql -(port:3306)-> mysql-service -(port:3306)-> mysql
```
- 위와 같은 2계층 웹 애플리케이션이 `alpha` 네임스페이스에 배포돼 있다. 
  웹 접속이 안되는 상황인데,이를 복구.
	- `mysql-service` 의 이름이 `mysql`로 설정돼 있었다. 현재 배포된 서비스를 삭제하고, 새로 정의해서 배포
```bash
controlplane ~ ➜  vi mysql-service.yaml
---
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
  namespace: alpha
spec:
  clusterIP: 10.43.187.171
  clusterIPs:
  - 10.43.187.171
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - port: 3306
    protocol: TCP
    targetPort: 3306
  selector:
    name: mysql
  sessionAffinity: None
  type: ClusterIP
---

controlplane ~ ➜  k apply -f mysql-service.yaml 
service/mysql-service created

controlplane ~ ➜  k get svc -n alpha
NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
mysql-service   ClusterIP   10.43.187.171   <none>        3306/TCP         8s
web-service     NodePort    10.43.124.240   <none>        8080:30081/TCP   16m
```

#### Application Failure TroubleShooting#2
```text
User -(port:30081)-> web-service -(port:8080)-> webapp-mysql -(port:3306)-> mysql-service -(port:3306)-> mysql
```
- 위와 같은 2계층 웹 애플리케이션이 `beta` 네임스페이스에 배포돼 있다. 
  웹 접속이 안되는 상황인데,이를 복구.
```bash
# 리소스 상태 확인
controlplane ~ ➜  k get all -n beta
NAME                                READY   STATUS    RESTARTS   AGE
pod/mysql                           1/1     Running   0          85s
pod/webapp-mysql-5c4c675768-9wchz   1/1     Running   0          85s

NAME                    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
service/mysql-service   ClusterIP   10.43.224.181   <none>        3306/TCP         85s
service/web-service     NodePort    10.43.8.152     <none>        8080:30081/TCP   85s

NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/webapp-mysql   1/1     1            1           85s

NAME                                      DESIRED   CURRENT   READY   AGE
replicaset.apps/webapp-mysql-5c4c675768   1         1         1       85s

# 웹서비스 이름 및 셀렉터, 포트 확인
controlplane ~ ➜  k get  svc web-service -n beta -o yaml
apiVersion: v1
kind: Service
metadata:
  creationTimestamp: "2025-08-18T06:36:03Z"
  name: web-service
  namespace: beta
  resourceVersion: "1310"
  uid: 34ab1f15-7d6b-4895-9810-0a96f3934079
spec:
  clusterIP: 10.43.8.152
  clusterIPs:
  - 10.43.8.152
  externalTrafficPolicy: Cluster
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - nodePort: 30081
    port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    name: webapp-mysql
  sessionAffinity: None
  type: NodePort
status:
  loadBalancer: {}

# 파드 이름 및 레이블 확인
controlplane ~ ➜  k get -n beta po webapp-mysql-5c4c675768-9wchz -o yaml
apiVersion: v1
kind: Pod
metadata:
  generateName: webapp-mysql-5c4c675768-
  generation: 1
  labels:
    name: webapp-mysql
    pod-template-hash: 5c4c675768
  name: webapp-mysql-5c4c675768-9wchz
  namespace: beta
...

# mysql 서비스 이름 및 셀렉터, 포트 확인
controlplane ~ ➜  k get -n beta svc mysql-service -o yaml
apiVersion: v1
kind: Service
metadata:
  creationTimestamp: "2025-08-18T06:36:03Z"
  name: mysql-service
  namespace: beta
  resourceVersion: "1293"
  uid: 8a45a872-e5bc-4942-bdde-8b4306f2a476
spec:
  clusterIP: 10.43.224.181
  clusterIPs:
  - 10.43.224.181
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - port: 3306
    protocol: TCP
    targetPort: 8080
  selector:
    name: mysql
  sessionAffinity: None
  type: ClusterIP
status:
  loadBalancer: {}
```

- `mysql-service`의 `targetPort`가 `mysql` 파드가 리스닝하고 있는 3306이 아닌 8080으로 설정돼 있음을 확인.
	- 기존 서비스 삭제 및 다음과 같이 수정하여 재배포
```bash
controlplane ~ ➜  k delete -n beta svc mysql-service 
service "mysql-service" deleted

controlplane ~ ➜  vi mysql-service.yaml 
---
...
  ports:
  - port: 3306
    protocol: TCP
    targetPort: 3306
...
---

controlplane ~ ➜  k apply -f mysql-service.yaml 
service/mysql-service created
```


#### Application Failure TroubleShooting#3
```text
User -(port:30081)-> web-service -(port:8080)-> webapp-mysql -(port:3306)-> mysql-service -(port:3306)-> mysql
```
- 위와 동일한 아키텍처로 `gamma` 네임스페이스에 웹 애플리케이션이 배포돼 있다. 현재 접속이 안되는데, 이를 복구
```bash
# 리소스 상태 확인
controlplane ~ ➜  k get all -n gamma 
NAME                                READY   STATUS    RESTARTS   AGE
pod/mysql                           1/1     Running   0          86s
pod/webapp-mysql-5c4c675768-zb8q4   1/1     Running   0          86s

NAME                    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
service/mysql-service   ClusterIP   10.43.208.59   <none>        3306/TCP         86s
service/web-service     NodePort    10.43.75.84    <none>        8080:30081/TCP   86s

NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/webapp-mysql   1/1     1            1           87s

NAME                                      DESIRED   CURRENT   READY   AGE
replicaset.apps/webapp-mysql-5c4c675768   1         1         1       87s
```

```bash
# web-service 통신 확인
controlplane ~ ➜  curl http://10.43.75.84:8080
```

```bash
# web-service name, ports, selectro 확인
controlplane ~ ➜  k get -n gamma svc web-service -o yaml
```

```bash
# webapp-mysql 파드 확인
controlplane ~ ➜  k get -n gamma po webapp-mysql-5c4c675768-zb8q4 -o yaml

controlplane ~ ✖ k describe po -n gamma webapp-mysql-5c4c675768-zb8q4 
```

```bash
controlplane ~ ➜  k describe svc -n gamma mysql-service 

controlplane ~ ➜  k get svc -n gamma mysql-service -o yaml
...
  ports:
  - port: 3306
    protocol: TCP
    targetPort: 3306
  selector:
    name: sql00001
...
```

```bash
# mysql 파드 확인
controlplane ~ ➜  k describe po -n gamma mysql

controlplane ~ ➜  k get po -n gamma mysql -o yaml
...
  labels:
    name: mysql
  name: mysql
...
```

- `mysql-service`의 `selector`가 잘못 설정돼 있음을 확인.
  기존 서비스를 삭제하고, `selector`를 수정해서 재배포
```bash
controlplane ~ ➜  vi mysql-service.yaml 
---
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
  namespace: gamma
spec:
  selector:
    name: mysql
  ports:
    - port: 3306
      protocol: TCP
      targetPort: 3306
---

controlplane ~ ➜  k apply -f mysql-service.yaml 
service/mysql-service created
```


#### Application Failure TroubleShooting#4
```text
User -(port:30081)-> web-service -(port:8080)-> webapp-mysql -(port:3306)-> mysql-service -(port:3306)-> mysql

# 환경변수
DB_Host: mysql-service
DB_User: root
DB_Password: paswrd
```
- 위와 동일한 아키텍처로 `delta` 네임스페이스에 웹 애플리케이션이 배포돼 있다. 현재 접속이 안되는데, 이를 복구
```bash
# 네임스페이스 내 리소스 확인
controlplane ~ ➜  k get all -n delta
```

```bash
# web-service 이름, 네임스페이스, 포트, 셀렉터 확인
controlplane ~ ➜  k get -n delta svc web-service -o yaml
```

```bash
# webapp-mysql 파드 이름, 레이블, 환경변수 등 확인
controlplane ~ ➜  k get po -n delta webapp-mysql-7dd5888bd4-b94z6 -o yaml
...
  containers:
  - env:
    - name: DB_Host
      value: mysql-service
    - name: DB_User
      value: sql-user
    - name: DB_Password
      value: paswrd
...
```

- `webapp-mysql` 파드의 환경변수 `DB_User`가 잘못 설정됨을 확인
  기존 파드(디플로이먼트) 삭제 후 재배포
```bash
controlplane ~ ➜  k delete po -n delta webapp-mysql-7dd5888bd4-b94z6 
pod "webapp-mysql-7dd5888bd4-b94z6" deleted
```

```bash
controlplane ~ ➜  vi webapp-mysql-depl.yaml
---
...
  containers:
  - env:
    - name: DB_Host
      value: mysql-service
    - name: DB_User
      value: root
    - name: DB_Password
      value: paswrd
...
```

```bash
controlplane ~ ➜  k apply -f webapp-mysql-depl.yaml 
deployment.apps/webapp-mysql created
```


#### Application Failure TroubleShooting#5
```text
User -(port:30081)-> web-service -(port:8080)-> webapp-mysql -(port:3306)-> mysql-service -(port:3306)-> mysql

# 환경변수
DB_Host: mysql-service
DB_User: root
DB_Password: paswrd
```
- 위와 동일한 아키텍처로 `eplsilon` 네임스페이스에 웹 애플리케이션이 배포돼 있다. 현재 접속이 안되는데, 이를 복구
```bash
controlplane ~ ➜  k get all -n epsilon 
```

```bash
controlplane ~ ➜  curl http://10.43.208.67:8080
```

- `webapp-mysql` 디플로이먼트의 환경변수가 잘못 설정됨을 확인
```bash
controlplane ~ ➜  k get deployments.apps -n epsilon webapp-mysql -o yaml
...
      containers:
      - env:
        - name: DB_Host
          value: mysql-service
        - name: DB_User
          value: sql-user
        - name: DB_Password
          value: paswr
...
```

- 기존 `webapp-mysql` 디플로이먼트 삭제 및 환경변수 수정 후 재배포
```bash
controlplane ~ ➜  k delete -n epsilon deploy webapp-mysql 
deployment.apps "webapp-mysql" deleted

controlplane ~ ➜  vi webapp-mysql-depl-epsilon.yaml
---
...
  containers:
  - env:
    - name: DB_Host
      value: mysql-service
    - name: DB_User
      value: root
    - name: DB_Password
      value: paswrd
...

controlplane ~ ➜  k apply -f webapp-mysql-depl-epsilon.yaml 
deployment.apps/webapp-mysql created
```

- 기존 `mysql` 파드의 환경변수 `MYSQL_ROOT_PASSWORD`가 잘못 설정됨을 확인.
```bash
controlplane ~ ➜  k get po -n epsilon mysql -o yaml
...
spec:
  containers:
  - env:
    - name: MYSQL_ROOT_PASSWORD
      value: passwooooorrddd
...
```

- 기존 `mysql` 파드 삭제 및 수정 후 재배포
```bash
controlplane ~ ➜  vi mysql-epsilon.yaml
...
spec:
  containers:
  - env:
    - name: MYSQL_ROOT_PASSWORD
      value: paswrd
...


controlplane ~ ➜  k apply -f mysql-epsilon.yaml 
pod/mysql created
```
  
#### Application Failure TroubleShooting#6
```text
User -(port:30081)-> web-service -(port:8080)-> webapp-mysql -(port:3306)-> mysql-service -(port:3306)-> mysql

# 환경변수
DB_Host: mysql-service
DB_User: root
DB_Password: paswrd
```
- 위와 동일한 아키텍처로 `zeta` 네임스페이스에 웹 애플리케이션이 배포돼 있다. 현재 접속이 안되는데, 이를 복구
```bash
controlplane ~ ➜  k get all -n zeta 
```

- `web-service`의 `targetPort`가 잘못 설정됨을 확인
```bash
controlplane ~ ➜  k get svc web-service -n zeta -o yaml
...
  ports:
  - nodePort: 30088
    port: 8080
    protocol: TCP
    targetPort: 8080
...
```

- 기존 `web-service` 삭제 및 `targetPort` 수정 후 재배포
```bash
controlplane ~ ➜  k delete -n zeta svc web-service 
service "web-service" deleted

controlplane ~ ➜  vi web-servive-zeta.yaml
...
  ports:
  - nodePort: 30081
    port: 8080
    protocol: TCP
    targetPort: 8080
...

controlplane ~ ➜  k apply -f web-servive-zeta.yaml 
service/web-service created
```

```bash
controlplane ~ ➜  curl http://10.43.11.124:8080
```

- `webapp-mysql` 디플로이먼트의 환경변수가 잘못 설정됨을 확인
```bash
controlplane ~ ✖ k get deployments.apps -n zeta webapp-mysql -o yaml
...
    spec:
      containers:
      - env:
        - name: DB_Host
          value: mysql-service
        - name: DB_User
          value: sql-user
        - name: DB_Password
          value: paswrd
...
```


- 기존 `webapp-mysql` 디플로이먼트 삭제 및 환경변수 수정 후 재배포
```bash
controlplane ~ ➜  k delete -n zeta deploy webapp-mysql 
deployment.apps "webapp-mysql" deleted

controlplane ~ ➜  vi webapp-depl-zeta.yaml 
...
        - name: DB_User
          value: root
...

controlplane ~ ➜  k apply -f webapp-depl-zeta.yaml 
deployment.apps/webapp-mysql created
```

```bash
controlplane ~ ➜  k get svc -n zeta mysql-service -o yaml
```

- 기존 `mysql` 파드의 환경변수 `MYSQL_ROOT_PASSWORD`가 잘못 설정됨을 확인.
```bash
controlplane ~ ➜  k get -n zeta po mysql -o yaml
...
  containers:
  - env:
    - name: MYSQL_ROOT_PASSWORD
      value: passwooooorrddd
...
```

- 기존 `mysql` 파드 삭제 및 수정 후 재배포
```bash
controlplane ~ ➜  k delete -n zeta po mysql 
pod "mysql" deleted

controlplane ~ ➜  vi mysql-pod-zeta.yaml 
...
  containers:
  - env:
    - name: MYSQL_ROOT_PASSWORD
      value: paswrd
...

controlplane ~ ➜  k apply -f mysql-pod-zeta.yaml 
pod/mysql created
```





---

# References
-