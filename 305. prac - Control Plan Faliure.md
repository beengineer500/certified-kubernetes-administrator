### 305. prac - Control Plan Faliure
#### Control Plan Faliure#1
- 컨트롤 플레인 내 파드 상태 확인
	- `kube-scheduler-controlplane` 비정상 확인
```bash
controlplane ~ ➜  k get no
NAME           STATUS   ROLES           AGE   VERSION
controlplane   Ready    control-plane   15m   v1.33.0


controlplane ~ ➜  k get po -A
NAMESPACE      NAME                                   READY   STATUS             RESTARTS     AGE
default        app-7f9667c9d9-h6gqm                   0/1     Pending            0            32s
kube-flannel   kube-flannel-ds-sfr52                  1/1     Running            0            15m
kube-system    coredns-7484cd47db-2rrmb               1/1     Running            0            15m
kube-system    coredns-7484cd47db-hrxc2               1/1     Running            0            15m
kube-system    etcd-controlplane                      1/1     Running            0            15m
kube-system    kube-apiserver-controlplane            1/1     Running            0            15m
kube-system    kube-controller-manager-controlplane   1/1     Running            0            15m
kube-system    kube-proxy-cb9nb                       1/1     Running            0            15m
kube-system    kube-scheduler-controlplane            0/1     CrashLoopBackOff   2 (8s ago)   33s
```

- `kube-scheduler-controlplane`의 이벤트 확인
	- 컨테이너 실행 중 `exec` 단계에서 `kube-schedulerrr` 실행파일을 찾을 수 없어, 명령 실행에 실패한 것을 확인
```bash
controlplane ~ ➜  k describe -n kube-system po kube-scheduler-controlplane 
...
Events:
  Type     Reason   Age                From     Message
  ----     ------   ----               ----     -------
  Normal   Pulled   8s (x4 over 59s)   kubelet  Container image "registry.k8s.io/kube-scheduler:v1.33.0" already present on machine
  Normal   Created  8s (x4 over 59s)   kubelet  Created container: kube-scheduler
  Warning  Failed   4s (x4 over 59s)   kubelet  Error: failed to create containerd task: failed to create shim task: OCI runtime create failed: runc create failed: unable to start container process: exec: "kube-schedulerrrr": executable file not found in $PATH: unknown
  Warning  BackOff  3s (x10 over 58s)  kubelet  Back-off restarting failed container kube-scheduler in pod kube-scheduler-controlplane_kube-system(d76b456c4ea4be6d2340029e30d9ad1d)
```

- `kube-scheduler`의 매니페스트를 확인
	- `spec.containers.command` 섹션에 잘못된 실행 파일이 명시돼있음을 확인
```bash
controlplane ~ ➜  cat /etc/kubernetes/manifests/kube-scheduler.yaml 
---
...
spec:
  containers:
  - command:
    - kube-schedulerrr
...
---
```

- `spec.containers.command` 섹션을 수정
```bash
controlplane ~ ➜  vi /etc/kubernetes/manifests/kube-scheduler.yaml 
---
...
spec:
  containers:
  - command:
    - kube-scheduler
...
---
```

- 파드 상태 확인인
```bash
controlplane ~ ➜  k get po -A
NAMESPACE      NAME                                   READY   STATUS    RESTARTS   AGE
default        app-7f9667c9d9-h6gqm                   1/1     Running   0          4m12s
kube-flannel   kube-flannel-ds-sfr52                  1/1     Running   0          18m
kube-system    coredns-7484cd47db-2rrmb               1/1     Running   0          18m
kube-system    coredns-7484cd47db-hrxc2               1/1     Running   0          18m
kube-system    etcd-controlplane                      1/1     Running   0          18m
kube-system    kube-apiserver-controlplane            1/1     Running   0          18m
kube-system    kube-controller-manager-controlplane   1/1     Running   0          18m
kube-system    kube-proxy-cb9nb                       1/1     Running   0          18m
kube-system    kube-scheduler-controlplane            1/1     Running   0          39s
```

#### Control Plane Failure#2
- `app` 디플로이먼트 `replicas`를 2로 변경
	- 변경했으나, 파드가 배포 안되는 상황. 이를 트러블 슈팅
```bash
controlplane ~ ➜  k edit deployments.apps app 
...
spec:
  progressDeadlineSeconds: 600
  replicas: 2
...
deployment.apps/app edited


controlplane ~ ➜  k get deploy
NAME   READY   UP-TO-DATE   AVAILABLE   AGE
app    1/2     1            1           5m55s
```

- 파드 상태 확인
	- `kube-controller-manager-controlplane` 장애를 확인
```bash
controlplane ~ ➜  k get po -A
NAMESPACE      NAME                                   READY   STATUS             RESTARTS      AGE
default        app-7f9667c9d9-h6gqm                   1/1     Running            0             6m45s
kube-flannel   kube-flannel-ds-sfr52                  1/1     Running            0             21m
kube-system    coredns-7484cd47db-2rrmb               1/1     Running            0             21m
kube-system    coredns-7484cd47db-hrxc2               1/1     Running            0             21m
kube-system    etcd-controlplane                      1/1     Running            0             21m
kube-system    kube-apiserver-controlplane            1/1     Running            0             21m
kube-system    kube-controller-manager-controlplane   0/1     CrashLoopBackOff   4 (30s ago)   2m8s
kube-system    kube-proxy-cb9nb                       1/1     Running            0             21m
kube-system    kube-scheduler-controlplane            1/1     Running            0             3m12s
```

- `kube-controller-manager` 세부사항 확인
	- `containers.kube-controller-manager.Command` 섹션의 `--kubeconfig`에 잘못된 컨피그 파일이름이 지정됨을 추정
```bash
controlplane ~ ➜  k describe -n kube-system po kube-controller-manager-controlplane 
...
containers.kube-controller-manager.Command
      --kubeconfig=/etc/kubernetes/controller-manager-XXXX.conf
...
```

- `/etc/kubernetes` 경로에서 컨피그 파일 이름 확인
```bash
controlplane ~ ➜  ls -l /etc/kubernetes
total 44
-rw------- 1 root root 5652 Aug 19 00:19 admin.conf
-rw------- 1 root root 5677 Aug 19 00:19 controller-manager.conf
-rw------- 1 root root 1993 Aug 19 00:19 kubelet.conf
drwxrwxr-x 1 root root 4096 Aug 19 00:44 manifests
drwxr-xr-x 3 root root 4096 Aug 19 00:19 pki
-rw------- 1 root root 5625 Aug 19 00:19 scheduler.conf
-rw------- 1 root root 5676 Aug 19 00:19 super-admin.conf
```

- `kube-controller-manager` 매니페스트에서 올바른 컨피그 파일 이름으로 수정
```bash
controlplane ~ ➜  vi /etc/kubernetes/manifests/kube-controller-manager.yaml 
...
    - --kubeconfig=/etc/kubernetes/controller-manager.conf
...
```

- 파드 확인인
```bash
controlplane ~ ➜  k get po -A
NAMESPACE      NAME                                   READY   STATUS    RESTARTS   AGE
default        app-7f9667c9d9-h6gqm                   1/1     Running   0          12m
default        app-7f9667c9d9-vrgs5                   1/1     Running   0          6s

...

kube-system    kube-controller-manager-controlplane   1/1     Running   0          27s

...
```

#### Control Plane Failure#3
- `app` 디플로이먼트 `replicas`를 3으로 변경했으나, 배포가 안되는 상황. 이를 트러블 슈팅
```bash
controlplane ~ ➜  k get deploy
NAME   READY   UP-TO-DATE   AVAILABLE   AGE
app    2/3     2            2           14m
```

- 파드 상태 확인
	- `kube-controller-manager-controlplane` 장애를 확인
```bash
controlplane ~ ➜  k get po -A
NAMESPACE      NAME                                   READY   STATUS             RESTARTS      AGE
default        app-7f9667c9d9-h6gqm                   1/1     Running            0             14m
default        app-7f9667c9d9-vrgs5                   1/1     Running            0             118s
kube-flannel   kube-flannel-ds-sfr52                  1/1     Running            0             29m
kube-system    coredns-7484cd47db-2rrmb               1/1     Running            0             29m
kube-system    coredns-7484cd47db-hrxc2               1/1     Running            0             29m
kube-system    etcd-controlplane                      1/1     Running            0             29m
kube-system    kube-apiserver-controlplane            1/1     Running            0             29m
kube-system    kube-controller-manager-controlplane   0/1     CrashLoopBackOff   3 (22s ago)   69s
kube-system    kube-proxy-cb9nb                       1/1     Running            0             29m
kube-system    kube-scheduler-controlplane            1/1     Running            0             10m
```

- `kube-controller-manager-controlplane` 세부사항 확인
	- 인증서가 잘못 설정된 것으로 추정
```bash
controlplane ~ ➜  k describe -n kube-system po kube-controller-manager-controlplane 
...

  k8s-certs:
    Type:          HostPath (bare host directory volume)
    Path:          /etc/kubernetes/WRONG-PKI-DIRECTORY
    HostPathType:  DirectoryOrCreate

...
```

- `kube-controller-manager` 매니페스트에서, `volumeMounts` 에 설정된 `k8s-certs`의 경로와 `volumes`에 설정된 `k8s-certs`의 경로가 상이함을 확인
	- 올바르게 수정
```bash
controlplane ~ ➜  vi /etc/kubernetes/manifests/kube-controller-manager.yaml 

...
    volumeMounts:
    ...
    - mountPath: /etc/kubernetes/pki
      name: k8s-certs
...
# volumeMounts 와 일치하도록 수정
  volumes:
  - hostPath:
      path: /etc/kubernetes/WRONG-PKI-DIRECTORY # pki로 수정
      type: DirectoryOrCreate
    name: k8s-certs
...
```

- `kubelet`을 재시작하여 `kube-controller-manager`가 재배포될 수 있도록 한다.
```bash
controlplane ~ ➜  systemctl restart kubelet
```

- 파드 확인
```bash
controlplane ~ ➜  k get po -A
NAMESPACE      NAME                                   READY   STATUS    RESTARTS   AGE
default        app-7f9667c9d9-h6gqm                   1/1     Running   0          28m
default        app-7f9667c9d9-sv4jp                   1/1     Running   0          57s
default        app-7f9667c9d9-vrgs5                   1/1     Running   0          15m

...

kube-system    kube-controller-manager-controlplane   1/1     Running   0          79s

...
```