### 258. ETCD in HA
**ETCD?**
- ETCD는 분산되고 신뢰할 수 있는 키-값 저장소이다. 간단하고 안전하며, 빠르다.
	- 키-값 저장소
		- 문서 또는 페이지 형태로 데이터를 저장한다.
		- 각 개인은 파일과 정보를 부여 받는다. 해당 개인에 대한 정보는 개인에게 부여된 파일 내에 저장된다. 파일은 모든 형식/구조가 가능하다.
		- 한 파일에 대한 변경사항은 다른 파일에 영향을 미치지 않는다.

- 여러 개의 ETCD 데이터베이스를 구성할 수 있다. 각 DB는 모두 동일한 데이터 복사본을 가진다.
- 이 경우 데이터의 일관성을 유지하는 것이 중요하다.
- 사용자가 쓰기와 같은 ETCD 데이터베이스의 값을 변경하는 작업을 할 시, ETCD는 전체 노드 중 하나의 노드를 리더로 선출한다. 사용자가 쓰기 작업을 할 경우, 리더 노드에 작업이 된다. 그리고 이 데이터 복사본이 다른 노드들에게 보내진다.

**Raft Protocol**
- ETCD는 Raft 프로토콜을 사용하여 분산 합의를 구현한다.
	- 여러 개의 마스터 노드가 있는 클러스터가 구성되면, 리더가 선출되지 않은 상태다.
	- Raft 프로토콜은 각 노드별로 임의의 타이머를 돌린다. 노드 중 타이머가 가장 먼저 끝난 곳이 다른 노드들에게 리더가 될 수 있는 권한을 요청을 보낸다.
	- 요청을 보낸 다른 노드들은 투표로 요청에 응답한다. 노드들로부터 투표를 받으면, 리더 권한 요청을 보낸 노드가 리더가 된다.
	- 리더가 된 이후, 리더 노드는 역할을 지속하고 있다는 알림 주기적으로 보낸다.
	- 리더 역할 지속 알림을 일정 시간 못 받는 경우, 리더 노드에 문제가 발생했다고 판단한다.
	- 남은 노드들끼리 리더 선출 프로세스를 다시 수행한다.

**Quorum (쿼럼)** 
- 쿼럼은 클러스터가 정상적으로 동작하기 위한 최소 노드의 개수를 말한다.
	- 쿼럼 = (전체 노드 수 N) / 2 + 1
		- 소수점은 버림한다. 

| Instances | Quorum | Fault Tolerance |
| --------- | ------ | --------------- |
| 1         | 1      | 0               |
| 2         | 2      | 0               |
| 3         | 2      | 1               |
| 4         | 3      | 1               |
| 5         | 3      | 2               |
| 6         | 4      | 2               |
| 7         | 4      | 3               |
- Fault Tolerance 를 보면 3과 4, 5와 6은 동일하다. 즉 마스터 노드가 늘어나도 유의미하지 않다. 따라서, 마스터 노드 개수는 홀수를 선택하는 것이 좋다.
- 마스터 노드 개수가 짝수인 경우, 네트워크 세분화 과정에서 클러스터 Fault가 발생할 가능성이 있다.
- 실질적으로 마스터 노드는 최대 5개로 충분하다. 내결함성을 보장할 수 있다.
- HA 설정에 필요한 최소 노드는 3개이다.

**`etcd.service`**
```bash
...
  # 다른 마스터 노드에 있는 ETCD 서버들의 위치 정보 옵션
  --initial-cluster peer-1=https://${PEER1_IP}:2380,peer-2=https://${PEER2_IP}:2380
...
```


**ETCDCTL**
- etcd를 설치하면, `etcdctl`를 사용해서 데이터를 저장/검색 가능하다.
- 버전은 v2, v3 두 가지가 있다. 기본값은 v2이다. 버전별로 명령어 차이가 존재한다.
- 우리는 v3를 사용할 것이다. 이를 위해 환경변수를 설정한다.
```bash
export ETCDCTL_API=3

etcdctl put name john

etcdctl get name

etcdctl get / --prefix --keys-only
```