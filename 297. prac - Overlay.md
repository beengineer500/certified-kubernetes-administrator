### 297. prac - Overlay
- 디렉터리 구조 확인
```bash
controlplane ~/code/k8s ➜  ls -R
.:
base  overlays

./base:
api-deployment.yaml  db-configMap.yaml  kustomization.yaml  mongo-depl.yaml

./overlays:
QA  dev  prod  staging

./overlays/QA:
kustomization.yaml

./overlays/dev:
api-patch.yaml  kustomization.yaml

./overlays/prod:
api-patch.yaml  kustomization.yaml  redis-depl.yaml

./overlays/staging:
configMap-patch.yaml  kustomization.yaml
```

- `prod` 환경에서 디플로이먼트가 배포하는 파드의 이미지 확인
```bash
controlplane k8s/overlays/prod ➜  cat api-patch.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-deployment
spec:
  template:
    spec:
      containers:
        - name: api
          image: memcached
```

- `prod` 환경에서 `api-deployment`의 `replicas` 확인
	- `api-patch.yaml`에 `replicas` 설정이 별도로 없으니, `base`의 기본 설정을 따른다.
```bash
controlplane k8s/overlays/prod ➜  cat ../../base/api-deployment.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      component: api
  template:
    metadata:
      labels:
        component: api
    spec:
      containers:
        - name: api
          image: nginx
          env:
            - name: DB_CONNECTION
              value: db.kodekloud.com
```

- `staging` 환경에서 `mongo` 컨테이너가 가지는 `password` 환경변수 값
```bash
controlplane k8s/overlays/staging ➜  cat kustomization.yaml 
bases:
  - ../../base
patches:
  - configMap-patch.yaml

controlplane k8s/overlays/staging ➜  cat configMap-patch.yaml 
apiVersion: v1
kind: ConfigMap
metadata:
  name: db-creds
data:
  username: mongo
  password: superp@ssword123
```

- `prod` 환경에서 배포될 총 파드 개수
```bash
controlplane k8s/overlays/prod ➜  cat redis-depl.yaml | grep replicas
  replicas: 2

controlplane k8s/overlays/prod ➜  cat ../../base/api-deployment.yaml | grep replicas
  replicas: 2

controlplane k8s/overlays/prod ➜  cat ../../base/mongo-depl.yaml | grep replicas
  replicas: 1
```

- `dev` 환경에서 `api-deployment`가 참조하는 환경변수 개수
	- `base`의 기본 매니페스트가 참조하는 환경 변수
	- `overlay/dev`의 패치가 참조하는 환경 변수
```bash
controlplane k8s/overlays/dev ➜  cat api-patch.yaml 
...
          env:
            - name: DB_USERNAME
              valueFrom:
                configMapKeyRef:
                  name: db-creds
                  key: username
            - name: DB_PASSWORD
              valueFrom:
                configMapKeyRef:
                  name: db-creds
                  key: password

controlplane k8s/overlays/dev ➜  cat ../../base/api-deployment.yaml 
...
          env:
            - name: DB_CONNECTION
              value: db.kodekloud.com
```

- `QA` 환경의 `api-deployment`의 도커 이미지를 json 9602 패치를 사용해서`caddy` 로 변경.
```bash
controlplane k8s/overlays/QA ✖ vi kustomization.yaml 
---
bases:
  - ../../base
commonLabels:
  environment: QA
patches:
  - target:
      kind: Deployment
      name: api-deployment
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: caddy
---

controlplane k8s/overlays/QA ➜  kubectl apply -k .
# Warning: 'bases' is deprecated. Please use 'resources' instead. Run 'kustomize edit fix' to update your Kustomization automatically.
# Warning: 'commonLabels' is deprecated. Please use 'labels' instead. Run 'kustomize edit fix' to update your Kustomization automatically.
configmap/db-creds created
deployment.apps/api-deployment created
deployment.apps/mongo-deployment created
```

- `staging` 환경에 `mysql-depl.yaml` 이름의 파일로 `mysql-deployment`를 배포하는 매니페스트를 작성
	- replicas: 1
	- image: mysql
	- env
		- name: MYSQL_ROOT_PASSWORD
		- value: mypassword
```bash
controlplane k8s/overlays/staging ➜  cat mysql-depl.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql-deployment
  template:
    metadata:
      labels:
        app: mysql-deployment
    spec:
      containers:
      - image: mysql
        name: mysql
        env:
          - name: MYSQL_ROOT_PASWORD
            value: mypassword
```

- `kustomization.yaml`에 `resources` 섹션에 정의한 디플로이먼트 파일을 명시하고 배포해야 한다.
```bash
controlplane k8s/overlays/staging ➜  cat kustomization.yaml 
bases:
  - ../../base
resources:
  - mysql-depl.yaml

commonLabels:
  environment: staging
```

```bash
controlplane k8s/overlays/staging ➜  k apply -k .
# Warning: 'bases' is deprecated. Please use 'resources' instead. Run 'kustomize edit fix' to update your Kustomization automatically.
# Warning: 'commonLabels' is deprecated. Please use 'labels' instead. Run 'kustomize edit fix' to update your Kustomization automatically.
configmap/db-creds created
deployment.apps/api-deployment created
deployment.apps/mongo-deployment created
deployment.apps/mysql-deployment created
```