### 316. prac - Advanced Kubectl commands
- 클러스터 노드 리스트를 json으로 받아서, 이를 `/opt/outputs/nodes.json`으로 저장
```bash
controlplane ~ ➜  k get no -o json > /opt/outputs/nodes.json

controlplane ~ ➜  ls /opt/outputs/
nodes.json
```

- `node01` 세부 정보를 json 포멧으로 받아서, 이를 이를 `/opt/outputs/node01.json`으로 저장
```bash
controlplane ~ ➜  k get no node01 -o json > /opt/outputs/node01.json

controlplane ~ ➜  ls /opt/outputs/
node01.json  nodes.json
```

- `jsonpath` 형태로 노드의 이름을 받고, 이를 `/opt/outputs/node_names.txt`에 저장
```bash
controlplane ~ ➜  k get no -o json
```

```bash
controlplane ~ ✖ k get no -o=jsonpath={'.items[*].metadata.name'}
controlplane node01

controlplane ~ ➜  k get no -o=jsonpath={'.items[*].metadata.name'} > /opt/outputs/node_names.txt

controlplane ~ ➜  cat /opt/outputs/node_names.txt 
controlplane node01
```

- JSON PATH 쿼리를 사용해 모든 노드의 `osImages`를 받아와, `/opt/outputs/nodes_os.txt`로 저장
```bash
controlplane ~ ➜  k get no -o json
...
                "nodeInfo": {
                    "architecture": "amd64",
                    "bootID": "f1b764c1-089e-4ddf-b407-8e813e110e56",
                    "containerRuntimeVersion": "containerd://1.6.26",
                    "kernelVersion": "5.15.0-1083-gcp",
                    "kubeProxyVersion": "",
                    "kubeletVersion": "v1.33.0",
                    "machineID": "92e237558a28443f8b62e79b11335638",
                    "operatingSystem": "linux",
                    "osImage": "Ubuntu 22.04.5 LTS",
...
```

```bash
controlplane ~ ➜  k get no -o=jsonpath={'.items[*].status.nodeInfo.osImage'}
Ubuntu 22.04.5 LTS Ubuntu 22.04.5 LTS

controlplane ~ ➜  k get no -o=jsonpath={'.items[*].status.nodeInfo.osImage'} > /opt/outputs/nodes_os.txt

controlplane ~ ✖ cat /opt/outputs/nodes_os.txt 
Ubuntu 22.04.5 LTS Ubuntu 22.04.5 LTS
```

- kube-config 파일이 `/root/my-kube-config`에 존재한다. 여기서 user name을 추출해서 `/opt/outputs/users.txt`로 저장
```bash
controlplane ~ ➜  k config view --kubeconfig=/root/my-kube-config -o=jsonpath={'.users[*].name'}
aws-user dev-user test-user

controlplane ~ ➜  k config view --kubeconfig=/root/my-kube-config -o=jsonpath={'.users[*].name'} > /opt/outputs/users.txt

controlplane ~ ➜  cat /opt/outputs/user.txt 
aws-user dev-user test-user
```

- PV를 capacity를 기준으로 정렬해서 출력하고, 이를 `/opt/outputs/storage-capacity-sorted.txt`로 저장한다.
```bash
controlplane ~ ✖ k get pv --sort-by=.spec.capacity.storage
NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE
pv-log-4   40Mi       RWX            Retain           Available                          <unset>                          26m
pv-log-1   100Mi      RWX            Retain           Available                          <unset>                          26m
pv-log-2   200Mi      RWX            Retain           Available                          <unset>                          26m
pv-log-3   300Mi      RWX            Retain           Available                          <unset>                          26m


controlplane ~ ➜  k get pv --sort-by=.spec.capacity.storage > /opt/outputs/storage-capacity-sorted.txt


controlplane ~ ➜  cat /opt/outputs/storage-capacity-sorted.txt
NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE
pv-log-4   40Mi       RWX            Retain           Available                          <unset>                          28m
pv-log-1   100Mi      RWX            Retain           Available                          <unset>                          28m
pv-log-2   200Mi      RWX            Retain           Available                          <unset>                          28m
pv-log-3   300Mi      RWX            Retain           Available                          <unset>                          28m
```

- PV를 capacity를 기준으로 정렬한다. 그리고, `--custom-columns`를 사용하여 `NAME, CAPACITY`만 출력한다. 이를 `/opt/outputs/pv-and-capacity-sorted.txt`에 저장
```bash
controlplane ~ ✖ k get pv --sort-by=.spec.capacity.storage -o custom-columns=NAME:.metadata.name,CAPACITY:.spec.capacity.storage
NAME       CAPACITY
pv-log-4   40Mi
pv-log-1   100Mi
pv-log-2   200Mi
pv-log-3   300Mi


controlplane ~ ➜  k get pv --sort-by=.spec.capacity.storage -o custom-columns=NAME:.metadata.name,CAPACITY:.spec.capacity.storage > /opt/outputs/pv-and-capacity-sorted.txt


controlplane ~ ➜  cat /opt/outputs/pv-and-capacity-sorted.txt
NAME       CAPACITY
pv-log-4   40Mi
pv-log-1   100Mi
pv-log-2   200Mi
pv-log-3   300Mi
```

- JSON PATH 쿼리를 사용하여, `my-kube-config` 내 `aws-user`를 추출하여, `/opt/outputs/aws-context-name`로 저장
```bash
    "users": [
        {
            "name": "aws-user",
            "user": {
                "client-certificate": "/etc/kubernetes/pki/users/aws-user/aws-user.crt",
                "client-key": "/etc/kubernetes/pki/users/aws-user/aws-user.key"
            }
        },
```

```bash
controlplane ~ ➜  k config view --kubeconfig=/root/my-kube-config -o=jsonpath="{.contexts[?(@.context.user=='aws-user')].name}"
aws-user@kubernetes-on-aws


controlplane ~ ➜  k config view --kubeconfig=/root/my-kube-config -o=jsonpath="{.contexts[?(@.context.user=='aws-user')].name}" > /opt/outputs/aws-context-name 


controlplane ~ ➜  cat /opt/outputs/aws-context-name 
aws-user@kubernetes-on-aws
```




---

# References
-