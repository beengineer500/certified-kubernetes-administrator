### 295. prac - Patches
- 배포되는 `nginx` 파드 개수
```bash
controlplane ~/code/k8s ➜  cat kustomization.yaml 
resources:
  - mongo-depl.yaml
  - nginx-depl.yaml
  - mongo-service.yaml

patches:
  - target:
      kind: Deployment
      name: nginx-deployment
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 3

  - target:
      kind: Deployment
      name: mongo-deployment
    path: mongo-label-patch.yaml

  - target:
      kind: Service
      name: mongo-cluster-ip-service
    patch: |-
      - op: replace
        path: /spec/ports/0/port
        value: 30000

      - op: replace
        path: /spec/ports/0/targetPort
        value: 30000
```

- `mongo` 디플로이먼트가 가지는 레이블
```bash
controlplane ~/code/k8s ➜  cat mongo-label-patch.yaml 
- op: add
  path: /spec/template/metadata/labels/cluster
  value: staging

- op: add
  path: /spec/template/metadata/labels/feature
  value: db

controlplane ~/code/k8s ➜  cat mongo-depl.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongo-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      component: mongo
  template:
    metadata:
      labels:
        component: mongo
    spec:
      containers:
        - name: mongo
          image: mongo
```

- `mongo` 서비스의 `tartgetPort`
```bash
controlplane ~/code/k8s ➜  cat kustomization.yaml 
resources:
  - mongo-depl.yaml
  - nginx-depl.yaml
  - mongo-service.yaml

patches:
...
  - target:
      kind: Service
      name: mongo-cluster-ip-service
    patch: |-
      - op: replace
        path: /spec/ports/0/port
        value: 30000

      - op: replace
        path: /spec/ports/0/targetPort
        value: 30000
```

- `api-deployment`가 배포하는 파드의 컨테이너 개수
```bash
controlplane ~/code/k8s ➜  cat kustomization.yaml 
resources:
  - mongo-depl.yaml
  - api-depl.yaml
  - mongo-service.yaml
  - host-pv.yaml
  - host-pvc.yaml

patches:
  - path: mongo-patch.yaml
  - path: api-patch.yaml

controlplane ~/code/k8s ➜  cat api-patch.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-deployment
spec:
  template:
    spec:
      containers:
        - name: memcached
          image: memcached

controlplane ~/code/k8s ➜  cat api-depl.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      component: api
  template:
    metadata:
      labels:
        component: api
    spec:
      containers:
        - name: nginx
          image: nginx
```

- `mongo` 디플로이먼트가 배포하는 파드가 PV와 마운트되는 경로
```bash
controlplane ~/code/k8s ➜  cat mongo-patch.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongo-deployment
spec:
  template:
    spec:
      containers:
        - name: mongo
          volumeMounts:
            - mountPath: /data/db
              name: mongo-volume
      volumes:
        - name: mongo-volume
          persistentVolumeClaim:
            claimName: host-pvc
```

- strategic merge patch 방법으로 `api-depl.yaml`에서 `memcached` 컨테이너를 삭제하는 `api-patch.yaml`를 작성
```bash
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-deployment
spec:
  template:
    spec:
      containers:
        - $patch: delete
          name: memcached

controlplane ~/code/k8s ➜  k apply -k .
service/mongo-cluster-ip-service unchanged
deployment.apps/api-deployment created
deployment.apps/mongo-deployment unchanged
```

- `mongo-deployment`에서 `org: KodeKloud` 레이블을 삭제하는 `kustomization.yaml` 작성
```bash
controlplane ~/code/k8s ➜  cat kustomization.yaml 
resources:
  - mongo-depl.yaml
  - api-depl.yaml
  - mongo-service.yaml

patches: 
  - target:
      kind: Deployment
      name: mongo-deployment
    patch: |-
      - op: remove
        path: /spec/template/metadata/labels/org

controlplane ~/code/k8s ➜  k apply -k .
service/mongo-cluster-ip-service created
deployment.apps/api-deployment created
deployment.apps/mongo-deployment created
```