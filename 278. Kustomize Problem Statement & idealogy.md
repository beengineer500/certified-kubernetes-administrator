### 278. Kustomize Problem Statement & idealogy
애플리케이션 구성을 위한 디플로이먼트, 서비스 등의 매니페스트들을 다양한 환경(dev, stg, prod 등)에 배포해야할 때, 각 환경별로 디렉터리를 구분하고 매니페스트들을 복사하여 수정하는 것은 가능은하지만 효율적이진 않다.

Kustomize는 매니페스트를 재사용하려고 할 때, 이를 각 환경별로 복사해 넣고 수정하지 않게 해준다. 변경해야할 부분만 수정하도록 해준다.

Kustomize는 **'Base, Overlay'** 2가지 핵심 개념으로 가능하게 한다.
- Base
	- base는 기본 구성 매니페스트를 의미한다.
	- 모든 환경에서 배포될 수 있는 기본 값이다.
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      component: nginx
  template:
    metadata:
      labels:
        component: nginx
    spec:
      containers:
        - name: nginx
          image: nginx
```

- Overlay
	- overlay를 통해서 환경별로 매니페스트의 일부를 수정할 수 있다.
	- 각 환경별로 오버레이를 만들 수 있다. 
```yaml
# overlay/dev
spec:
  replicas: 1

# overlay/prod
spec:
  replicas: 5

# overlay/stg
spec:
  replicas: 2
```


#### Kustomize 디렉터리 구조
- `base`
	- 모든 기본 구성을 포함한다.
- `overlay`
	- 환경별로 오버레이 하위에 디렉터리가 존재한다.
	- 각 환경 디렉터리 내에서 base의 기본 매니페스트의 값을 덮어쓰기 위한 파일들이 존재한다.
```text
k8s
├─ base/
│  ├─ kustomization.yaml
│  ├─ nginx-depl.yaml
│  ├─ service.yaml
│  └─ redis-depl.yaml
└─ overlays/
   ├─ dev/
   │  ├─ kustomization.yaml
   │  └─ config-map.yaml
   ├─ stg/
   │  ├─ kustomization.yaml
   │  └─ config-map.yaml
   └─ prod/
      ├─ kustomization.yaml
      └─ config-map.yaml
```

#### Kustomize 워크 플로
- Base의 기본 매니페스트와 Overlay의 파일을 합쳐서 최종 매니페스트를 만들어 배포한다.

#### Kustomize의 장점
- `kubectl`에 내장돼 있어 다른 패키지를 설치할 필요가 없다. 대신, `kubectl` 버전에 따라 `kustomize`가 최신 버전이 아닐 수도 있기 때문에 최신 버전을 별도로 설치할 수는 있다.
-  `helm`처럼 템플릿 표현을 배우고 작성하지 않아도 된다. 기본 YAML 형식을 따라, Base를 작성하고, Overlay에서도 기본 YAML 형식에 맞게 덮어쓸 값을 작성하기만 하면 된다.