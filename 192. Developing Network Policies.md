### 192. Developing Network Policies
- 네트워크 정책 생성
	- DB Pod가 3306 포트를 통해 API Pod로부터 수신 트래픽만 허용
		- 들어오는 트래픽에 대해서 허용하면, 해당 트래픽의 응답으로 나가는 트래픽은 자동으로 허용된다. (Stateful)
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: db-policy
spec:
  podSelector:
    matchLabels:
      role: db
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          name: api-pod
    ports:
    - protocol: TCP
      port: 3306
```

- 클러스터에 동일한 레이블을 가지고 있는 여러 파드가 있는 경우,  `prod` 네임스페이스에 있는 파드로부터의 트래픽만을 허용하는 네트워크 폴리시 생성
```yaml
...
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          name: api-pod
      namespaceSelector:    # 추가
        matchLabels:
          name: prod
    ports:
    - protocol: TCP
      port: 3306
```
 
- 클러스터 외부에 백업 DB가 있는 경우, 백업 DB로부터 오는 트래픽을 허용
	- 백업 서버 IP : 192.168.5.10
```yaml
...
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          name: api-pod
      namespaceSelector: 
        matchLabels:
          name: prod
    - ipBlock:                    # 추가
        cidr: 192.168.5.10/32
    ports:
    - protocol: TCP
      port: 3306
```

- 네트워크 폴리시에서 `-(대시)`의 유무는 Selector의 `AND와 OR`을 결정한다.
	- 하나의 `-`  블록에 셀렉터가 여러 개 있는 경우 => 각 셀렉터는 AND 관계
	- 셀렉터 별로 `-`가 있는 경우 => 각 셀렉터는 OR 관계

- AND : `name: api-pod` 레이블을 가지며 `prod` 네임스페이스에 있는 파드의 트래픽만 허용
```bash
    - podSelector:
        matchLabels:
          name: api-pod
      namespaceSelector: 
        matchLabels:
          name: prod
```

- OR : `name: api-pod` 레이블을 가지거나 `prod` 네임스페이스에 있는 파드들의 트래픽 허용
```yaml
    - podSelector:
        matchLabels:
          name: api-pod
    - namespaceSelector: 
        matchLabels:
          name: prod
```

- 백업 DB 서버로 보내는 트래픽을 허용
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  role: db
spec:
   podSelector:
     matchLabels:
       role: db
   PolicyTypes:
   - Ingress
   - Egress
   ingress:
   - from 
	 - podSelector:
       matchLabels:
         name: api-pod
     ports:
     - protocol: TCP
       port: 3306
    egress:
	- to:
	  - ipBlock:
	      cide: 192.168.5.10/32
      ports:
      - protocol: TCP
        port: 80
```