### 176. prac - RBAC
- 현재 클러스터에서 사용하고 있는 인증 메커니즘 확인
```bash
controlplane ~ ➜  cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep -i auth
    - --authorization-mode=Node,RBAC
    - --enable-bootstrap-token-auth=true
```

- default 네임스페이스의 현재 역할 목록 확인
```bash
controlplane ~ ➜  kubectl get roles
No resources found in default namespace.
```

- 전체 네임스페이스의 현재 역할 목록 확인
```bash
controlplane ~ ➜  kubectl get roles -A
NAMESPACE     NAME                                             CREATED AT
blue          developer                                        2025-08-08T16:40:26Z
kube-public   kubeadm:bootstrap-signer-clusterinfo             2025-08-08T16:34:47Z
kube-public   system:controller:bootstrap-signer               2025-08-08T16:34:46Z
kube-system   extension-apiserver-authentication-reader        2025-08-08T16:34:46Z
kube-system   kube-proxy                                       2025-08-08T16:34:48Z
kube-system   kubeadm:kubelet-config                           2025-08-08T16:34:47Z
kube-system   kubeadm:nodes-kubeadm-config                     2025-08-08T16:34:47Z
kube-system   system::leader-locking-kube-controller-manager   2025-08-08T16:34:46Z
kube-system   system::leader-locking-kube-scheduler            2025-08-08T16:34:46Z
kube-system   system:controller:bootstrap-signer               2025-08-08T16:34:46Z
kube-system   system:controller:cloud-provider                 2025-08-08T16:34:46Z
kube-system   system:controller:token-cleaner                  2025-08-08T16:34:46Z

controlplane ~ ➜  kubectl get roles -A | wc -l
13
```

- kube-proxy 역할에 대해 허용돼있는 Resource 확인
```bash
controlplane ~ ✖ kubectl describe role kube-proxy -n kube-system
Name:         kube-proxy
Labels:       <none>
Annotations:  <none>
PolicyRule:
  Resources   Non-Resource URLs  Resource Names  Verbs
  ---------   -----------------  --------------  -----
  configmaps  []                 [kube-proxy]    [get]
```

- kube-proxy가 연결돼있는 account 확인
	- `Group:system:bootstrappers:kubeadm:default-node-token`
```bash
controlplane ~ ➜  k describe rolebinding kube-proxy -n kube-system
Name:         kube-proxy
Labels:       <none>
Annotations:  <none>
Role:
  Kind:  Role
  Name:  kube-proxy
Subjects:
  Kind   Name                                             Namespace
  ----   ----                                             ---------
  Group  system:bootstrappers:kubeadm:default-node-token  
```

- 새로 생성된 `dev-user`가 default 네임스페이스의 파드 목록 조회가 가능한지 확인
```bash
controlplane ~ ➜  kubectl auth can-i get pods --as dev-user
no
```

- `dev-user`를 위한 role, roleBinding 생성
```bash
controlplane ~ ➜  k get role developer -n blue -o yaml >> dev-user-role.yaml

controlplane ~ ➜  vi dev-user-role.yaml 
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: developer
  namespace: default
rules:
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
  - watch
  - create
  - delete
  - list
---



controlplane ~ ✖ k get rolebindings dev-user-binding -n blue -o yaml >> dev-user-binding.yaml

controlplane ~ ➜  vi dev-user-binding.yaml
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: dev-user-binding
  namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: developer
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: User
  name: dev-user
---

controlplane ~ ✖ k apply -f dev-user-role.yaml 
role.rbac.authorization.k8s.io/developer created

controlplane ~ ➜  k apply -f dev-user-binding.yaml 
rolebinding.rbac.authorization.k8s.io/dev-user-binding created
```

- 트러블 슈팅
```bash
controlplane ~ ➜  kubectl auth can-i get pods --as dev-user
yes

controlplane ~ ➜  kubectl get role developer -n blue -o yaml > blue-dev-user-role.yaml


# 현재 정보 확인
controlplane ~ ➜  cat blue-dev-user-role.yaml 
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  creationTimestamp: "2025-08-08T16:40:26Z"
  name: developer
  namespace: blue
  resourceVersion: "887"
  uid: 207e6391-656c-4c62-aec6-91b7b793f019
rules:
- apiGroups:
  - ""
  resourceNames:
  - blue-app
  resources:
  - pods
  verbs:
  - get
  - watch
  - create
  - delete


# 수정
controlplane ~ ➜  vi blue-dev-user-role.yaml 
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  creationTimestamp: "2025-08-08T16:40:26Z"
  name: developer
  namespace: blue
  resourceVersion: "887"
  uid: 207e6391-656c-4c62-aec6-91b7b793f019
rules:
- apiGroups:
  - ""
  resourceNames:
  - dark-blue-app
  resources:
  - pods
  verbs:
  - get
  - watch
  - create
  - delete
---

controlplane ~ ➜ k apply -f blue-dev-user-role.yaml 
role.rbac.authorization.k8s.io/developer created
```

- `blue` 네임스페이스의  `developer` 역할에, 디플로이먼트를 생성할 수 있는 권한을 추가
```bash
controlplane ~ ➜  kubectl get role -n blue
NAME        CREATED AT
developer   2025-08-09T02:46:21Z

controlplane ~ ➜  kubectl edit role -n blue developer 
role.rbac.authorization.k8s.io/developer edited

controlplane ~ ➜  vi dev-user-role.yaml 
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: developer
  namespace: blue
rules:
...
- apiGroups:    # 추가
  - apps
  resources:
   - deployments
  verb:
  - create
---
```




---

# References
-