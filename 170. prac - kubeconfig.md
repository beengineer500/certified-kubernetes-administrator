### 170. prac - kubeconfig
- kubeConfig 파일 및 내용 확인
	- 클러스터 개수, 사용자 수, 컨텍스트 개수
```bash
controlplane ~/.kube ➜  cat config 
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: ...
    server: https://controlplane:6443
  name: kubernetes
contexts:
- context:
    cluster: kubernetes
    user: kubernetes-admin
  name: kubernetes-admin@kubernetes
current-context: kubernetes-admin@kubernetes
kind: Config
preferences: {}
users:
- name: kubernetes-admin
  user:
    client-certificate-data: ...
    client-key-data: ...
```

- 새로운 컨피그 파일 `my-kube-config` 및 내용 확인
```bash
controlplane ~ ➜  cat my-kube-config 
apiVersion: v1
kind: Config

clusters:
- name: production
  cluster:
    certificate-authority: /etc/kubernetes/pki/ca.crt
    server: https://controlplane:6443

- name: development
  cluster:
    certificate-authority: /etc/kubernetes/pki/ca.crt
    server: https://controlplane:6443

- name: kubernetes-on-aws
  cluster:
    certificate-authority: /etc/kubernetes/pki/ca.crt
    server: https://controlplane:6443

- name: test-cluster-1
  cluster:
    certificate-authority: /etc/kubernetes/pki/ca.crt
    server: https://controlplane:6443

contexts:
- name: test-user@development
  context:
    cluster: development
    user: test-user

- name: aws-user@kubernetes-on-aws
  context:
    cluster: kubernetes-on-aws
    user: aws-user

- name: test-user@production
  context:
    cluster: production
    user: test-user

- name: research
  context:
    cluster: test-cluster-1
    user: dev-user

users:
- name: test-user
  user:
    client-certificate: /etc/kubernetes/pki/users/test-user/test-user.crt
    client-key: /etc/kubernetes/pki/users/test-user/test-user.key
- name: dev-user
  user:
    client-certificate: /etc/kubernetes/pki/users/dev-user/developer-user.crt
    client-key: /etc/kubernetes/pki/users/dev-user/dev-user.key
- name: aws-user
  user:
    client-certificate: /etc/kubernetes/pki/users/aws-user/aws-user.crt
    client-key: /etc/kubernetes/pki/users/aws-user/aws-user.key

current-context: test-user@development
preferences: {}
```

- 특정 컨피그 파일을 지정해서, `kubectl` 명령을 사용하여 컨텍스트 전환
```bash
> controlplane ~ ✖ kubectl config use-context research --kubeconfig=/root/my-kube-config 

Switched to context "research".
```

- 디폴트 kubeConfig 파일을 변경
	- `KUBECONFIG` 환경변수를 설정하고, 이를 `~/.bashrc`에 등록함으로써 가능하다.
```bash
controlplane ~ ➜  echo "export KUBECONFIG=/root/my-kube-config" >> ~/.bashrc

controlplane ~ ➜  tail -1 ~/.bashrc
export KUBECONFIG=/root/my-kube-config

controlplane ~ ➜  exec bash

controlplane ~ ➜  echo $KUBECONFIG
/root/my-kube-config

controlplane ~ ➜  kubectl config view
apiVersion: v1
clusters:
- cluster:
    certificate-authority: /etc/kubernetes/pki/ca.crt
    server: https://controlplane:6443
  name: development
- cluster:
    certificate-authority: /etc/kubernetes/pki/ca.crt
    server: https://controlplane:6443
  name: kubernetes-on-aws
- cluster:
    certificate-authority: /etc/kubernetes/pki/ca.crt
    server: https://controlplane:6443
  name: production
- cluster:
    certificate-authority: /etc/kubernetes/pki/ca.crt
    server: https://controlplane:6443
  name: test-cluster-1
contexts:
- context:
    cluster: kubernetes-on-aws
    user: aws-user
  name: aws-user@kubernetes-on-aws
- context:
    cluster: test-cluster-1
    user: dev-user
  name: research
- context:
    cluster: development
    user: test-user
  name: test-user@development
- context:
    cluster: production
    user: test-user
  name: test-user@production
current-context: research
kind: Config
preferences: {}
users:
- name: aws-user
  user:
    client-certificate: /etc/kubernetes/pki/users/aws-user/aws-user.crt
    client-key: /etc/kubernetes/pki/users/aws-user/aws-user.key
- name: dev-user
  user:
    client-certificate: /etc/kubernetes/pki/users/dev-user/developer-user.crt
    client-key: /etc/kubernetes/pki/users/dev-user/dev-user.key
- name: test-user
  user:
    client-certificate: /etc/kubernetes/pki/users/test-user/test-user.crt
    client-key: /etc/kubernetes/pki/users/test-user/test-user.key
```

- 현재 research 컨텍스트를 사용하고 있는데, `kubectl get po` 명령이 동작하지 않는다. 원인을 파악하고 복구
	- 인증서 파일명 불일치에 따라서 오류 발생. 컨피그 파일의 값을 올바르게 수정함으로써 복구
	- 컨피그 파일 수정한 뒤 별도 작업 필요 없이, 바로 `kubectl` 명령 사용하면 된다. `kubectl`이 자동으로 컨피그 파일을 참조해서 api-server와 인증하기 때문이다.
```bash
controlplane ~ ➜  kubectl config view
...
- context:
    cluster: test-cluster-1
    user: dev-user
  name: research
...
- name: dev-user
  user:
    client-certificate: /etc/kubernetes/pki/users/dev-user/developer-user.crt
    client-key: /etc/kubernetes/pki/users/dev-user/dev-user.key

# 인증서 파일 확인
controlplane ~ ➜  ll /etc/kubernetes/pki/users/dev-user/
total 20
drwxr-xr-x 2 root root 4096 Aug  8 13:17 ./
drwxr-xr-x 5 root root 4096 Aug  8 13:17 ../
-rw-r--r-- 1 root root 1025 Aug  8 13:20 dev-user.crt
-rw-r--r-- 1 root root  924 Aug  8 13:20 dev-user.csr
-rw------- 1 root root 1704 Aug  8 13:20 dev-user.key

# 인증서 파일명 불일치에 따라서 오류 발생. config 수정을 복구
controlplane ~ ➜  vi my-kube-config 
---
...
client-certificate: /etc/kubernetes/pki/users/dev-user/dev-user.crt
...
---
```