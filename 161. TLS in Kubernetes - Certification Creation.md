### 161. TLS in Kubernetes - Certification Creation
- 인증서 생성을 위해서는 여러 도구 사용이 가능하다. 여기서는 OpenSSL을 통해 인증서를 생성한다.

#### CA(인증기관) 인증서 및 키 생성
- Step1) Generate Keys(키 생성)
	- `openssl` 명령을 사용해서 키를 생성한다.
```bash
openssl genrsa -out ca.key 2048
```

- Step2) Certificate Signing Request(인증서 서명 요청)
	- 생성한 키를 활용하여 Certificate Signing Request(인증서 서명 요청)을 생성한다.
		- 명령의 이름 또는 CN 필드에서 인증서가 사용되는 구성 요소의 이름을 지정한다.
```bash
openssl req -new -key ca.key -subj "/CN=KUBERNETES-CA" -out ca.csr
```

 - Step3) Sign Certificates (인증서 서명)
	 - 현재 생성하는 인증서는 CA 자신을 위한 것이다. 따라서 Step1에서 생성한 자체 키를 사용하여 자체 서명한다.
```bash
openssl x509 -req -in ca.csr -signkey ca.key -out ca.crt
```


#### 클라이언트 사이드 인증서 및 키 생성
- Admin 관리자의 인증서와 키 생성 과정을 예시로 진행.

- Step1) Generate Keys(키 생성)
	- `openssl` 명령을 사용해서 키를 생성한다.
```bash
openssl genrsa -out admin.key 2048
```

- Step2) Certificate Signing Request(인증서 서명 요청)
	- 생성한 키를 활용하여 Certificate Signing Request(인증서 서명 요청)을 생성한다.
		- 명령의 이름 또는 CN 필드에서 인증서가 사용되는 구성 요소의 이름을 지정한다.
			- 여기서는 `kube-admin`으로 지정했다. 다른 이름을 사용해도 된다.
			- 여기서 지정한 이름이 `kubectl` 명령을 사용할 때, 인증되는 이름이다. 로그에 해당 이름이 남는다.
			- Admin과 일반 사용자의 요청/인증은 구분돼야 한다. 이는 인증서 서명 요청에서 그룹 세부정보를 추가함으로써 구분 가능하다. 여기서는 Admin을 `system:masters` 그룹에 추가한다.
```bash
openssl req -new -key admin.key -subj "/CN=kube-admin/O=systemLmasters" -out admin.csr
```

 - Step3) Sign Certificates (인증서 서명)
	 - CA 인증서와 CA키를 지정하여 `admin.crt`를 인증 서명.
	 - `KUBERNETES-CA` 키 쌍의 인증을 받아야만 클러스터 내에서 유효한 인증서가 된다.
```bash
openssl x509 -req -in admin.csr -CA ca.crt -CAkey ca.key -out admin.crt  
```

#### '인증서-키 쌍' 활용 클라이언트-서버 통신 암호화
- 위 과정을 통해 생성된 '인증서 - 키'를 사용하여, '사용자 이름 - 패스워드' 대신 API 요청을 암호화할 수 있다.
```bash
curl https://kube-apiserver:6443/api/v1/pods --key admin.key --cert admin.crt --cacert ca.crt
```

- `kube-config.yaml`에 설정하여 '인증서-키 쌍' 적용하는 것도 가능하다.
```yaml
apiVersion: v1
clusters:
- cluster:
    certificate-authority: ca.crt
    server: https://kube-apiserver:6443
  name: kubernetes
kind: config
users:
- name: kubernetes-admin
  user:
    client-certificate: admin.crt
    client-key: admin.key
```

`kube-scheduler, kube-controller-manager, kube-proxy` 는 컨트롤 플레인의 시스템 구성요소 중 하나이다. 따라서 인증서 서명 요청 시, `system:` 접두사가 `CN` 필드에 붙어야 한다.
```bash
# kube-scheduler
openssl req -new -key kube-scheduler.key -subj "/CN=system:kube-scheduler" -out kube-scheduler.csr

# kube-controller-manager
openssl req -new -key kube-controller-manager.key -subj "/CN=system:kube-controller-manager.key" -out kube-controller-manager.csr


# kube-proxy
openssl req -new -key kube-proxy.key -subj "/CN=system:kube-proxy.key" -out kube-proxy.csr
```

쿠버네티스 내에서 서로를 확인하려면 CA의 루트 인증서 `ca.crt` 사본이 필요하다. 따라서 쿠버네티스의 모든 서버 구성요소, 클라이언트들은 루트 인증서 `ca.crt`를 지정 및 설정해야 한다.

#### 서버 사이드 인증서 및 키 생성

`etcd`
- '인증서 생성 - 인증서 서명 요청 - 인증서 서명'은 위의 클라이언트 과정과 동일하다
- `etcd`는 고가용성을 위해 홀수 개로 클러스터 구성이 될 수 있다. 이 경우 각 `etcd` 서버 서로를 인증하기 위해 각 `etcd` 별로 인증서-키 쌍을 생성한다. 각 `etcd`는 다른 모든 `etcd`의 인증서-키 쌍을 가지고 있는다.
- 인증서를 생성한 뒤, 인증서를 `etcd.yaml` 컨피그 값으로 설정한다.
```yaml
- etcd
    - --advertise-client-urls=https:127.0.0.1:2379
    - --key-file=/<PATH_TO_CERTS>/etcdserver.key
    - --cert-file=/<PATH_TO_CERTS>/etcdserver.crt
    - --client-cert-auth=true
    - --data-dir=/var/lib/etcd
    - --initial-advertise-peer-urls=https:127.0.0.1:2380
    - --initial-cluster-master=https://127.0.0.1:2380
    - --listen-client-urls=https://127.0.0.2379
    - --listen-peer-urls=https://127.0.0.1:2380
    - --name=master
    - --peer-cert-file=/<PATH_TO_CERTS>/etcdpeer1.crt
    - --peer-client-cert-auth=true
    - --peer-key-file=/etc/kubernetes/pki/etcd/peer.key
    - --peer-trusted-ca-file=/etc/kubernetes/kpi/etcd/ca.crt
    - --snapshot-count=10000
    - --trusted-ca-file=/etc/kuberentes/pki/etcd/ca.crt
```

#### API Server
- API 서버는 쿠버네티스 내외부에서 가장 많은 구성요소와 통신한다.
- 각 구성요소별로 kube-apiserver를 부르는 명칭이 다르다.
	- `kubernetes`
	- `kubernetes.default`
	- `kubernetes.default.svc`
	- `kubernetes.default.svc.cluster.local`
	- `kubernetes.default.svc.cluster.local`
	- `<KUBE-API-SERVER-IP>`
- `kube-apiserver` 키 생성
	- `apiserver.key`
```bash
openssl genrsa -out apiserver.key 2048
```
- `kuber-apiserver` 인증서 서명 요청 생성
	- `apiserver.csr`
```Bash
openssl req -new -key apiserver.key -subj \
“/CN=kube-apiserver” -out apiserver.csr
```
- 여러 구성요소들이 `kube-apiserver`를 호출할 때 사용하는 이름들 설정
```bash
vi openssl.cnf
---
…
[Alt_names]
DNS.1 = kubernetes
DNS.2 = kubernetes.default
DNS.3 = kubernetes.default.svc
DNS.4 = kubernetes.default.svc.cluster.local
IP.1 = 10.96.0.1
IP.2 = 172.17.0.87
…
```

- `kube-apiserver` 인증서 서명 요청을 CA 인증서 쌍으로 서명하여 인증서 생성
	- `apiserver.crt`
```bash
openssl x509 -req -in apiserver.csr \
-CA ca.crt -CAkey ca.key \
-out apiserver.crt
```


#### `kubelet` 서버
- kubelet은 노드별로 존재한다. 각 노드별로 존재하는 kubelet 인증서의 이름은 노드의 이름을 따서 지정한다.
	- `systme:node:<NODE_NAME>`
- kubelet이 존재하는 모든 노드에서 `kubelet-config.yaml`에 root 인증서 쌍을 지정해야한다.