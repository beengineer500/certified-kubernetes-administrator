### 181. Service Accounts
 - 쿠버네티스에는 2가지 Account(계정)이 있다.
	 - User Account
		 - 사용자가 사용한다. 
		 - 관리자 또는 일반 사용자가 사용한다.
	 - Service Account
		 - 시스템이 사용한다.
		 - 쿠버네티스와 상호작용하는 애플리케이션에서 사용한다.
			 - 프로메테우스, 젠킨스 등
		- 애플리케이션들은 쿠버네티스와 상호작용하기 위해서, API를 사용한다. 쿠버네티스는 API를 통해 들어온 요청을 인증하는데, 애플리케이션에서 인증을 위해 서비스 어카운트를 사용한다.

- 서비스 어카운트 생성 및 확인
```bash
kubectl create serviceaccount dashboard-sa

kubectl get serviceaccount
```

- 쿠버네티스는 서비스 어카운트를 생성하면, 토큰을 자동으로 생성한다. 다음을 통해서 확인 가능하다.
	- 서비스 어카운트 토큰은 쿠버네티스에게 인증을 위해, 외부 애플리케이션에서 사용하는 것이다. 
	- 토큰은 Secret 오브젝트로 저장된다.
```bash
kubectl describe serviceaccount dashboard-sa
```

- 서비스 어카운트를 생성하면, 서비스 어카운트는 토큰을 생성한다. 그리고 시크릿 오브젝트를 생성해, 그 안에 토큰 정보를 저장한다. 토큰 정보를 가지고 있는 시크릿은 서비스 어카운트에 연결된다.

- 토큰 정보를 자세히 보기 위해서는 시크릿을 확인해야 한다.
```bash
kubectl describe secret dashboard-sa-token-kbbdm
```

- 쿠버네티스는 모든 네임스페이스에 대해 default 서비스 어카운트를 자동으로 생성한다.
	- 파드가 생성될 때마다, default 서비스 계정과 토큰은 볼륨 마운트 형태로 파드에게 마운트된다.
	- `kubectl describe pod <POD_NAME>` 을 통해서 확인하면 `secret` 타입의 볼륨이 자동으로 마운트되는 것을 확인할 수 있다.
	- 서비스 어카운트 토큰 시크릿은 파드 내부의 `/var/run/secrets/kubernetes.io/serviceaccount` 경로에 마운트된다.
	- `default` 서비스 어카운트는 파드에 자동으로 마운트 된다. 이를 막기 위해서는 `spec.automountServiceAccountToken: false`를 설정해야 한다.

- 파드는 이미 연결돼 있는 서비스 어카운트를 수정할 수 없다. 파드를 삭제하고, 서비스 아카운트 필드를 수정한 다음 다시 배포해야한다.
- 디플로이먼트는 생성돼 있는 상태에서 서비스 어카운트를 수정할 수 있다. 서비스 어카운트가 변경되면 디플로이먼트는 기존에 배포했던 파드들을 삭제하고 새로운 파드를 생성한다.


#### k8s-v1.24 이후 변경사항
- 쿠버네티스 v1.24부터는 서비스 어카운트를 생성해도, 자동으로 토큰/시크릿이 생성되지 않는다. 필요하다면, v1.22에 도입된 token API를 사용해서 별도로 생성해야 한다. 
- 토큰을 디코딩하면, 만료날짜를 확인할 수 있다. 별도로 설정하지 않는 한, 명령을 실행한 시점부터 1시간이다.
```bash
kubectl create serviceaccount dashboard-sa

kubectl create token dashboard-sa
```