---
index: 
tags: 
created: 2025-05-26 09:20
status: 
source_url:
---
### 168. prac - Certificate API
- 참고자료 : [k8s Docs](https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/)
- 주어진 `/root/akshay.csr` 파일의 내용을 활용하여, `akshay` 이름으로 CertificateSigningRequest를 생성.
	- CSR의 API version : `certificates.k8s.io/v1`
	- CSR 생성 시 `signerName` 필드를 작성해야만 하며, signer 로는 쿠버네티스 내장 signer인 `kubernetes.io/kube-apiserver-client`를 사용
```bash
> cat /root/akshay.csr 
-----BEGIN CERTIFICATE REQUEST-----
MIICVjCCAT4CAQAwETEPMA0GA1UEAwwGYWtzaGF5MIIBIjANBgkqhkiG9w0BAQEF
AAOCAQ8AMIIBCgKCAQEAvPOliJ6I+1+r6w6IheD1au25p6Udxkwpwr9Xf4y5Gdc5
MeFFePgy6nHmAI+QLW9oVRGcqIg9nW5b2X2kAaq3I5K3G6uEGeTw3O/Lt12koZSK
52mDt3wC51J50qkSjErpguG83ygh96weEfLqHAxWafMA0XMHFV93MAUGXWfAae4B
rYJEUJJ/IFypO4EmDf3smyyvQXav1r6y0c8IVvLJQ07EIk5pWyI4oUU7jENeHb7m
sn4ihNe3hHQK7+7s+h7BeA9VAuJHJhmfIK4iRIEtvgIioLXaabEXkMj0WDyTPydD
LPLQbSK65eu3Q324lEDn3jEjcSkGWrRdMAiqH0jTqQIDAQABoAAwDQYJKoZIhvcN
AQELBQADggEBAJNcdhZ6BQ3tbP3jcFkcNoTjtYjBORIuPjWC7ArRt/7BeRcSYj38
FBUDoNCW20WVbdATLRxN7dUaU/uSQmfNZNmOxNZ9/iL/4Imlz455k6qNZOa/SWVD
Aa2AnT6ip9/QuT2ixD0xm8Ua7ykK0wV6UnpEzH8KNaB4Irxp4lCo5tqFxd9zKgTk
4yhqXTwElvrVlLSo2IndF+SvzqKlyqAWQ9JVg5L2+sjYMmXXRRzXyGMdPmTe9x5f
X/023oxAr0t5WRgElJrkCFULnjXonXP0qvwVnKym59TzA86Z0VxYR71tk9cdydD/
uZx13Ytla71CZjHmsX7Hjtn7awLg/2F4fIE=
-----END CERTIFICATE REQUEST-----

> cat /root/akshay.csr | base64 -w0
LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ1ZqQ0NBVDRDQVFBd0VURVBNQTBHQTFVRUF3d0dZV3R6YUdGNU1JSUJJakFOQmdrcWhraUc5dzBCQVFFRgpBQU9DQVE4QU1JSUJDZ0tDQVFFQXZQT2xpSjZJKzErcjZ3NkloZUQxYXUyNXA2VWR4a3dwd3I5WGY0eTVHZGM1Ck1lRkZlUGd5Nm5IbUFJK1FMVzlvVlJHY3FJZzluVzViMlgya0FhcTNJNUszRzZ1RUdlVHczTy9MdDEya29aU0sKNTJtRHQzd0M1MUo1MHFrU2pFcnBndUc4M3lnaDk2d2VFZkxxSEF4V2FmTUEwWE1IRlY5M01BVUdYV2ZBYWU0QgpyWUpFVUpKL0lGeXBPNEVtRGYzc215eXZRWGF2MXI2eTBjOElWdkxKUTA3RUlrNXBXeUk0b1VVN2pFTmVIYjdtCnNuNGloTmUzaEhRSzcrN3MraDdCZUE5VkF1SkhKaG1mSUs0aVJJRXR2Z0lpb0xYYWFiRVhrTWowV0R5VFB5ZEQKTFBMUWJTSzY1ZXUzUTMyNGxFRG4zakVqY1NrR1dyUmRNQWlxSDBqVHFRSURBUUFCb0FBd0RRWUpLb1pJaHZjTgpBUUVMQlFBRGdnRUJBSk5jZGhaNkJRM3RiUDNqY0ZrY05vVGp0WWpCT1JJdVBqV0M3QXJSdC83QmVSY1NZajM4CkZCVURvTkNXMjBXVmJkQVRMUnhON2RVYVUvdVNRbWZOWk5tT3hOWjkvaUwvNEltbHo0NTVrNnFOWk9hL1NXVkQKQWEyQW5UNmlwOS9RdVQyaXhEMHhtOFVhN3lrSzB3VjZVbnBFekg4S05hQjRJcnhwNGxDbzV0cUZ4ZDl6S2dUawo0eWhxWFR3RWx2clZsTFNvMkluZEYrU3Z6cUtseXFBV1E5SlZnNUwyK3NqWU1tWFhSUnpYeUdNZFBtVGU5eDVmClgvMDIzb3hBcjB0NVdSZ0VsSnJrQ0ZVTG5qWG9uWFAwcXZ3Vm5LeW01OVR6QTg2WjBWeFlSNzF0azljZHlkRC8KdVp4MTNZdGxhNzFDWmpIbXNYN0hqdG43YXdMZy8yRjRmSUU9Ci0tLS0tRU5EIENFUlRJRklDQVRFIFJFUVVFU1QtLS0tLQo=

> vi akshay-csr.yaml
apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: akshay
spec:
  request: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ1ZqQ0NBVDRDQVFBd0VURVBNQTBHQTFVRUF3d0dZV3R6YUdGNU1JSUJJakFOQmdrcWhraUc5dzBCQVFFRgpBQU9DQVE4QU1JSUJDZ0tDQVFFQXZQT2xpSjZJKzErcjZ3NkloZUQxYXUyNXA2VWR4a3dwd3I5WGY0eTVHZGM1Ck1lRkZlUGd5Nm5IbUFJK1FMVzlvVlJHY3FJZzluVzViMlgya0FhcTNJNUszRzZ1RUdlVHczTy9MdDEya29aU0sKNTJtRHQzd0M1MUo1MHFrU2pFcnBndUc4M3lnaDk2d2VFZkxxSEF4V2FmTUEwWE1IRlY5M01BVUdYV2ZBYWU0QgpyWUpFVUpKL0lGeXBPNEVtRGYzc215eXZRWGF2MXI2eTBjOElWdkxKUTA3RUlrNXBXeUk0b1VVN2pFTmVIYjdtCnNuNGloTmUzaEhRSzcrN3MraDdCZUE5VkF1SkhKaG1mSUs0aVJJRXR2Z0lpb0xYYWFiRVhrTWowV0R5VFB5ZEQKTFBMUWJTSzY1ZXUzUTMyNGxFRG4zakVqY1NrR1dyUmRNQWlxSDBqVHFRSURBUUFCb0FBd0RRWUpLb1pJaHZjTgpBUUVMQlFBRGdnRUJBSk5jZGhaNkJRM3RiUDNqY0ZrY05vVGp0WWpCT1JJdVBqV0M3QXJSdC83QmVSY1NZajM4CkZCVURvTkNXMjBXVmJkQVRMUnhON2RVYVUvdVNRbWZOWk5tT3hOWjkvaUwvNEltbHo0NTVrNnFOWk9hL1NXVkQKQWEyQW5UNmlwOS9RdVQyaXhEMHhtOFVhN3lrSzB3VjZVbnBFekg4S05hQjRJcnhwNGxDbzV0cUZ4ZDl6S2dUawo0eWhxWFR3RWx2clZsTFNvMkluZEYrU3Z6cUtseXFBV1E5SlZnNUwyK3NqWU1tWFhSUnpYeUdNZFBtVGU5eDVmClgvMDIzb3hBcjB0NVdSZ0VsSnJrQ0ZVTG5qWG9uWFAwcXZ3Vm5LeW01OVR6QTg2WjBWeFlSNzF0azljZHlkRC8KdVp4MTNZdGxhNzFDWmpIbXNYN0hqdG43YXdMZy8yRjRmSUU9Ci0tLS0tRU5EIENFUlRJRklDQVRFIFJFUVVFU1QtLS0tLQo=
  signerName: kubernetes.io/kube-apiserver-client
  usages:
    - client auth
      
> kubectl apply -f akshay-csr.yaml
```

- 생성한 `akshay` CSR의 상태 확인
```bash
> kubectl get csr
NAME        AGE    SIGNERNAME                                    REQUESTOR                  REQUESTEDDURATION   CONDITION
akshay      7m3s   kubernetes.io/kube-apiserver-client           kubernetes-admin           <none>              Pending
csr-hvlqn   41m    kubernetes.io/kube-apiserver-client-kubelet   system:node:controlplane   <none>              Approved,Issued
```

- `akshay` CSR 승인
```bash
> kubectl certificate approve akshay
certificatesigningrequest.certificates.k8s.io/akshay approved

> kubectl get csr
NAME        AGE     SIGNERNAME                                    REQUESTOR                  REQUESTEDDURATION   CONDITION
akshay      7m59s   kubernetes.io/kube-apiserver-client           kubernetes-admin           <none>              Approved,Issued
csr-hvlqn   42m     kubernetes.io/kube-apiserver-client-kubelet   system:node:controlplane   <none>              Approved,Issued
```

- 새로 추가된 CSR 확인
```bash
controlplane ~ ➜  kubectl get csr
NAME          AGE     SIGNERNAME                                    REQUESTOR                  REQUESTEDDURATION   CONDITION
agent-smith   1s      kubernetes.io/kube-apiserver-client           agent-x                    <none>              Pending
akshay        8m41s   kubernetes.io/kube-apiserver-client           kubernetes-admin           <none>              Approved,Issued
csr-hvlqn     43m     kubernetes.io/kube-apiserver-client-kubelet   system:node:controlplane   <none>              Approved,Issued
```

- `agent-smith` CSR의 그룹 확인
```bash
controlplane ~ ➜  kubectl get csr agent-smith -o yaml
...
  groups:
  - system:masters
  - system:authenticated
...
```

- 그룹이 부적절하니, 해당 CSR은 거절
```bash
controlplane ~ ➜  kubectl certificate deny agent-smith
certificatesigningrequest.certificates.k8s.io/agent-smith denied

controlplane ~ ➜  kubectl get csr
NAME          AGE     SIGNERNAME                                    REQUESTOR                  REQUESTEDDURATION   CONDITION
agent-smith   2m34s   kubernetes.io/kube-apiserver-client           agent-x                    <none>              Denied
akshay        11m     kubernetes.io/kube-apiserver-client           kubernetes-admin           <none>              Approved,Issued
csr-hvlqn     45m     kubernetes.io/kube-apiserver-client-kubelet   system:node:controlplane   <none>              Approved,Issued
```

- 해당 CSR 삭제
```bash
kubectl delete csr agent-smith
certificatesigningrequest.certificates.k8s.io "agent-smith" deleted
```




---

# References
- 