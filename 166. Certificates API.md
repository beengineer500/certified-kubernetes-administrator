### 166. Certificates API
- 쿠버네티스 내에는 CA가 존재한다. 이는 사실 상 한 쌍의 키일 뿐이다. CA 인증키 쌍은 안전하게 관리돼야만 한다.
- 쿠버네티스의 마스터 노드는 CA 서버이기도 하다.
- '인증서 생성 - 서명 요청 - 서명 - 인증서 만료 및 삭제 - 인증서 갱신' 등의 작업을 사용자가 많아짐에 따라 자동화할 필요가 있다.
- 쿠버네티스에는 Certificate API(인증서 API)가 내장돼 있다.
	- 1) 사용자는 인증서 API를 사용하여, 관리자에게 인증서 서명 요청을 보낸다. API 호출을 통해 쿠버네티스에 직접 연결된다.
	- 2) 관리자가 인증서 서명 요청일 받았을 때, 관리자가 수동으로 CA 서버에 접속하는 대신, 스스로 인증서에 서명하고 쿠버네티스 API 객체인 `CertificateSigningRequest Object`를 만든다.
- `CertificateSigningRequest Object` 객체가 생성되면, 관리자는 모든 인증서 서명 요청을 확인할 수 있다.
	- 인증서 서명 요청을 확인할 수 있다.
	- `kubectl` 명령을 통해서 승인을 할 수 있다.
	- 서명한 인증서를 CA 서버로부터 추출하고, 사용자에게 공유할 수 있다.
 - 절차
	 - 1) 사용자가 키를 생성한다.
		 - `opensssl genrsa -out user.key`
	 - 2) 사용자가 생성한 키를 사용해 인증서 서명 요청을 생성한다. 이를 관리자에게 요청한다.
		 - `openssl req -new -key user.key -subj "/CN=user -out user.csr`
	- 3) 관리자는 사용자의 인증서 서명 요청을 수신하고, `CertificateSigningRequest` 개체를 생성한다.
		- `request` 필드에는 사용자가 보낸 인증서 서명 요청을 기입한다. 이 때, 일반 텍스트가 아닌 Base64로 인코딩한 값을 기입한다.
			-  `cat user.csr | base64`
			```yaml
			apiVersion: certificates.k8s.io/v1
			kind: CertificateSigningRequest
			metadata:
			  name: user
			spec:
			  expirationSeconds: 600
			  usages:
			  - digital signature
			  - key encipherment
			  - server auth
			  request:
			```
	- 4) `CertificateSigningRequest` 객체를 생성하면, 관리자는 모든 인증서 서명 요청을 `kubectl` 명령으로 확인 가능하다. 승인도 가능하다.
		- 확인 : `kubectl get csr`
		- 승인 : `kubectl certificate approve <CSR_NAME>`
	- 5) 관리자가 사용자의 인증 서명 요청을 승인하면, 쿠버네티스는 CA 키 쌍을 사용하여 인증서에 서명한다. 그리고 사용자를 위한 인증서를 생성한다. 이를 추출하여 사용자에게 공유 가능하다.
	- 6) 인증서를 yaml 형식으로 확인 가능하다.
		- `kubectl get csr <CSR_NAEM> -o yaml`
			- `status.certificate` 필드에 Base64 인코딩 형식으로 인증서 확인이 가능하다.
			- 텍스트트로 확인하기 위해서는 디코딩해야 한다.
				- `echo "<STATUS.CERTIFICATE>" | base64 --decode`
- 쿠버네티스에서 위와 같은 인증서 라이프 사이클에 책임이 있고, 실제로 수행하는 컴포넌트는 `kube-contoller-manager`이다.
	- 컨트롤러 매니저 내부에 인증서를 위한 컨트롤러가 있다.
		- `CSR-APPROVING`
		- `CSR-SIGNING`
- 인증서 서명을 위해서는 CA Root 인증서-키 쌍이 필요하다. 이는 `kube-contoller-manger.yaml`에서 확인 가능하며, CA Root 인증서를 지정할 수 있는 옵션이 있다.
	- `cat /etc/kubernetes/manifests/kube-controller-manager.yaml` 
		- `--cluster-signing-cert-file=<CA_CERT_PATH>`
		- `--cluster-signing-key-file=<CA_KEY_PATH>`





---

# References
-